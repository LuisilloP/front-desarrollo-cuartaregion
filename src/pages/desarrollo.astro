---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/layout/Navbar.astro";
import Footer from "../components/layout/Footer.astro";
import SectionDivider from "../components/layout/SectionDivider.astro";
import WhatsAppFloatingButton from "../components/layout/WhatsAppFloatingButton.astro";
import SectionHero from "../components/common/sections/SectionHero.astro";
import ValueSection from "../components/common/sections/ValueSection.astro";
import ServicesSection from "../components/desarrollo/ServicesSection.astro";
import TrustSection from "../components/common/sections/TrustSection.astro";
import CtaFormSection from "../components/common/sections/CtaFormSection.astro";
import { fetchSiteSettings, fetchServices } from "../lib/api/services";
import type { Content, DevelopmentPageContent } from "../lib/api/types";
import contentJson from "../data/content.json";
import developmentJson from "../data/pages/desarrollo.json";

const siteSettings = await fetchSiteSettings();
const services = await fetchServices();
const content = contentJson as Content;
const developmentContent = developmentJson as DevelopmentPageContent;

const { hero, value, servicesSection, trust, cta, seo } = developmentContent;
const pageTitle = seo?.title ?? "Desarrollo Web y Software | Aliado Digital";
const pageDescription =
  seo?.description ??
  "Desarrollo web y software a medida para pymes, profesionales y negocios locales de Chile.";

const excludeTypes = (servicesSection.excludeTypes ?? []).map((type) =>
  String(type).toLowerCase(),
);
const includeTypes = (servicesSection.includeTypes ?? []).map((type) =>
  String(type).toLowerCase(),
);
const filteredServices = services.filter((service) => {
  const type = (service.type ?? "").toLowerCase();
  if (includeTypes.length > 0) {
    return includeTypes.includes(type);
  }
  if (excludeTypes.length > 0) {
    return !excludeTypes.includes(type);
  }
  return true;
});
const servicesForPage =
  filteredServices.length > 0 ? filteredServices : services;
---

<Layout
  title={pageTitle}
  description={pageDescription}
  siteSettings={siteSettings}
>
  <Navbar siteSettings={siteSettings} navLinks={content.navLinks} />
  <main class="overflow-x-hidden">
    <SectionHero
      sectionId="desarrollo-hero"
      title={hero.title}
      subtitle={hero.subtitle}
      primaryCta={hero.primaryCta}
      secondaryCta={hero.secondaryCta}
      slides={hero.slides}
      imageSrc={hero.imageSrc}
      imageAlt={hero.imageAlt}
    />

    <SectionDivider tone="accent" />

    <ValueSection
      title={value.title}
      description={value.description}
      quote={value.quote}
      items={value.items}
    />

    <SectionDivider />

    <ServicesSection
      title={servicesSection.title}
      description={servicesSection.description}
      services={servicesForPage}
      whatsappNumber={siteSettings.whatsappNumber}
    />

    <SectionDivider />

    <TrustSection
      title={trust.title}
      description={trust.description}
      logos={trust.logos}
    />

    <SectionDivider />

    <CtaFormSection
      title={cta.title}
      description={cta.description}
      ctaLabel={cta.ctaLabel}
      sectionId={cta.sectionId}
      formId={cta.formId}
    />
  </main>
  <Footer
    siteSettings={siteSettings}
    navLinks={content.navLinks}
    legalPages={content.legalPages}
  />
  <WhatsAppFloatingButton
    whatsappNumber={siteSettings.whatsappNumber}
    message="Hola! Quiero un desarrollo a medida."
  />
</Layout>
