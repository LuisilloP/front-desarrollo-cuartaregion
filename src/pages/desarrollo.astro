---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/layout/Navbar.astro";
import Footer from "../components/layout/Footer.astro";
import SectionDivider from "../components/layout/SectionDivider.astro";
import WhatsAppFloatingButton from "../components/layout/WhatsAppFloatingButton.astro";
import HeroBackgroundSlideshow from "../components/hero/HeroBackgroundSlideshow.astro";
import GoogleG from "../components/ui/GoogleG.astro";
import PlansSection from "../components/development/PlansSection.astro";
import ProcessSection from "../components/sections/ProcessSection.astro";
import CasesSection from "../components/sections/CasesSection.astro";
import PortfolioMarqueeSection from "../components/sections/PortfolioMarqueeSection.tsx";
import ContactSection from "../components/sections/ContactSection.astro";
import { companies as portfolioFallbackCompanies } from "../content/portfolioProjects";
import type { Company } from "../content/portfolioProjects";
import { fetchSiteSettings, fetchServices, fetchCases } from "../lib/api/services";
import type { CaseStudy, Content, DevelopmentPageContent } from "../lib/api/types";
import contentJson from "../data/content.json";
import developmentJson from "../data/pages/development.json";
import developmentCasesJson from "../data/pages/development-cases.json";
import developmentClientsJson from "../data/pages/development-clients.json";
import { env } from "../lib/env";

const siteSettings = await fetchSiteSettings();
const services = await fetchServices();
const cases = await fetchCases();
const content = contentJson as Content;
const developmentContent = developmentJson as DevelopmentPageContent;
const developmentClients = developmentClientsJson as {
  title?: string;
  description?: string;
  companies?: Company[];
};

const { hero, trust, cta, seo, value, plansSection, plans } = developmentContent;
const pageTitle =
  seo?.title ?? "Desarrollo Web y Software para Pymes | Aliado Digital";
const pageDescription =
  seo?.description ??
  "Desarrollo web y software a medida para pymes en Chile. Sitios rápidos, escalables y listos para crecer.";

const servicesForPage = services.filter(
  (service) => (service.type ?? "").toLowerCase() !== "digital",
);
const fallbackCases = content.cases ?? [];
const casesSource = cases.length > 0 ? cases : fallbackCases;
const developmentCases = (developmentCasesJson.slugs ?? [])
  .map((slug) => casesSource.find((item) => item.slug === slug))
  .filter((item): item is CaseStudy => Boolean(item));
const casesForPage =
  developmentCases.length > 0 ? developmentCases : casesSource;

const slides =
  hero?.slides?.length
    ? hero.slides ?? []
    : hero?.imageSrc
      ? [{ src: hero.imageSrc, alt: hero.imageAlt ?? "" }]
      : [];
const heroEyebrow = value?.eyebrow ?? "PROPUESTA DE VALOR";
const heroHeading =
  hero?.title ?? value?.title ?? "Desarrollo web y software a medida para pymes.";
const heroDescription =
  hero?.subtitle ??
  value?.description ??
  "Webs rápidas, escalables y listas para crecer.";
const primaryCta =
  hero?.primaryCta ??
  (value?.ctaLabel && value?.ctaHref
    ? { label: value.ctaLabel, href: value.ctaHref }
    : undefined);
const secondaryCta = hero?.secondaryCta ?? { label: "Ver planes", href: "#planes" };
const heroCtaNote = value?.ctaNote;

const isExternalCta = Boolean(primaryCta?.href?.startsWith("http"));
const items = value?.items ?? [];

const portfolioTitle =
  developmentClients.title ??
  trust?.title ??
  "Equipos que confían en nuestro desarrollo";
const portfolioDescription =
  developmentClients.description ??
  trust?.description ??
  "Trabajamos con negocios que buscan tecnología estable, segura y con soporte real.";
const companiesForMarquee =
  developmentClients.companies && developmentClients.companies.length > 0
    ? developmentClients.companies
    : portfolioFallbackCompanies;

const contactContent = {
  eyebrow: "Hablemos",
  title:
    cta?.title ?? "¿Listo para dar el siguiente paso con tu web?",
  description:
    cta?.description ??
    "Cuéntanos lo que tienes en mente y te ayudamos a planificarlo bien desde el inicio.",
  socialLinks: content.siteSettings.socialLinks,
};
const contactSectionId = cta?.sectionId ?? "contacto-desarrollo";
const contactWhatsappMessage =
  "Hola! Quiero cotizar un desarrollo web a medida.";
const contactPrimaryCtaLabel =
  cta?.ctaLabel ?? "Hablemos de tu desarrollo";
const secondaryHrefRaw = hero?.secondaryCta?.href ?? "#planes";
const contactSecondaryCtaLabel =
  hero?.secondaryCta?.label ?? "Ver planes disponibles";
const contactSecondaryCtaHref = secondaryHrefRaw.startsWith("#")
  ? `/desarrollo${secondaryHrefRaw}`
  : secondaryHrefRaw;

const siteUrl = env.siteUrl ?? (Astro.site ? Astro.site.toString() : undefined);
const canonical = Astro.url
  ? Astro.url.toString()
  : siteUrl
    ? new URL("/desarrollo", siteUrl).toString()
    : undefined;
const logoUrl = siteUrl ? new URL("/logo.svg", siteUrl).toString() : undefined;
const provider = {
  "@type": "Organization",
  name: siteSettings.siteName,
  ...(siteUrl ? { url: siteUrl } : {}),
  ...(logoUrl ? { logo: { "@type": "ImageObject", url: logoUrl } } : {}),
};
const toAbsolute = (path: string) =>
  siteUrl ? new URL(path, siteUrl).toString() : path;
const areaServedItems = [
  ...(siteSettings.region
    ? [{ "@type": "Place", name: siteSettings.region }]
    : []),
  { "@type": "Country", name: "Chile" },
];
const areaServed =
  areaServedItems.length === 1 ? areaServedItems[0] : areaServedItems;
const developmentOfferItems = servicesForPage.map((service) => ({
  "@type": "Offer",
  itemOffered: {
    "@type": "Service",
    name: service.title,
    description: service.what_it_solves ?? undefined,
    serviceType: "Desarrollo web y software",
  },
}));
const developmentServiceSchema = {
  "@context": "https://schema.org",
  "@type": "Service",
  name: "Desarrollo web y software a medida",
  description: pageDescription,
  serviceType: "Desarrollo web y software",
  ...(canonical ? { url: canonical } : {}),
  ...(areaServed ? { areaServed } : {}),
  provider,
  ...(developmentOfferItems.length > 0
    ? {
        hasOfferCatalog: {
          "@type": "OfferCatalog",
          name: "Planes de desarrollo y software",
          itemListElement: developmentOfferItems,
        },
      }
    : {}),
};
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "Inicio",
      item: toAbsolute("/"),
    },
    {
      "@type": "ListItem",
      position: 2,
      name: "Desarrollo",
      item: canonical ?? "/desarrollo",
    },
  ],
};
---

<Layout
  title={pageTitle}
  description={pageDescription}
  siteSettings={siteSettings}
  structuredData={[developmentServiceSchema, breadcrumbSchema]}
>
  <Navbar
    siteSettings={siteSettings}
    navLinks={content.navLinks}
    forceTransparent
  />
  <main class="overflow-x-hidden">
    <section id="desarrollo-hero" class="relative min-h-screen overflow-hidden">
      <div class="absolute inset-0 z-0">
        {slides.length > 0 ? (
          <HeroBackgroundSlideshow
            slides={slides}
            intervalMs={7000}
            transitionMs={1200}
          />
        ) : null}
      </div>

      <div class="absolute inset-0 z-10 bg-gradient-to-t from-black/70 via-black/50 to-transparent"></div>
      <div class="absolute inset-0 z-10 backdrop-blur-[2px]"></div>

      <div class="section-shell relative z-20 flex min-h-screen items-center py-24 sm:py-28 lg:py-32">
        <div class="grid w-full gap-12 lg:grid-cols-[1.05fr_0.95fr] lg:items-start">
          <div class="space-y-5" data-reveal="fade-up">
            {heroEyebrow ? (
              <p class="text-xs font-semibold uppercase tracking-[0.28em] text-white/70">
                {heroEyebrow}
              </p>
            ) : null}
            <h1 class="text-4xl font-semibold leading-tight text-white sm:text-5xl lg:text-6xl">
              {heroHeading}
            </h1>
            <p class="max-w-prose text-lg text-white/80 sm:text-xl">
              {heroDescription}
            </p>

            {primaryCta?.label && primaryCta?.href ? (
              <div class="mt-6 space-y-3">
                <div class="flex flex-col gap-4 sm:flex-row">
                  <a
                    href={primaryCta.href}
                    target={isExternalCta ? "_blank" : undefined}
                    rel={isExternalCta ? "noopener noreferrer" : undefined}
                    class="inline-flex w-full min-w-[240px] items-center justify-center gap-2 rounded-full bg-white px-7 py-3 text-sm font-semibold text-slate-900 shadow-lg shadow-black/20 transition-all duration-200 hover:-translate-y-0.5 hover:bg-white/90 sm:w-auto sm:min-w-[260px]"
                  >
                    <GoogleG size={16} />
                    <span>{primaryCta.label}</span>
                  </a>
                  <a
                    href={secondaryCta.href}
                    class="inline-flex w-full min-w-[240px] items-center justify-center rounded-full border border-white/40 px-7 py-3 text-sm font-semibold text-white/90 transition-all duration-200 hover:-translate-y-0.5 hover:border-white/70 sm:w-auto sm:min-w-[220px]"
                  >
                    {secondaryCta.label}
                  </a>
                </div>
                {heroCtaNote ? (
                  <p class="max-w-[52ch] text-sm leading-snug text-white/70">
                    {heroCtaNote}
                  </p>
                ) : null}
              </div>
            ) : null}
          </div>

          <div class="mt-2 space-y-4 sm:mt-0 sm:space-y-6" data-reveal="fade-up" data-delay="120">
            <div class="grid gap-4 sm:gap-6">
              {items.map((item) => {
                const labelText = (item.label ?? item.title ?? "").toLowerCase();
                const normalizedLabelText = labelText
                  .normalize("NFD")
                  .replace(/[\u0300-\u036f]/g, "")
                  .replace(/[^a-z0-9\s]/g, "")
                  .replace(/\s+/g, " ")
                  .trim();
                const isGeneric =
                  normalizedLabelText.includes("sin sistema") ||
                  normalizedLabelText.includes("sin base") ||
                  normalizedLabelText.includes("generico");
                const isCustom =
                  normalizedLabelText.includes("con metodo") ||
                  normalizedLabelText.includes("con mtodo") ||
                  normalizedLabelText.includes("a medida");

                const cardTone = isGeneric
                  ? "border-rose-300/50 bg-rose-500/25 hover:border-rose-200/80"
                  : isCustom
                    ? "border-emerald-300/50 bg-emerald-500/25 hover:border-emerald-200/80"
                    : "border-white/20 bg-white/25 hover:border-white/35";

                const bulletTone = isGeneric
                  ? "bg-rose-300/90"
                  : isCustom
                    ? "bg-emerald-300/90"
                    : "bg-white/70";

                return (
                  <article
                    class:list={[
                      "group rounded-2xl border p-5 backdrop-blur-lg backdrop-saturate-150 transition-all duration-300 hover:-translate-y-0.5 sm:p-6",
                      cardTone,
                    ]}
                  >
                    {item.label ? (
                      <p class="text-xs font-semibold uppercase tracking-[0.2em] text-white/70">
                        {item.label}
                      </p>
                    ) : null}
                    <h3 class="mt-3 text-lg font-semibold text-white">
                      {item.title}
                    </h3>
                    <p class="mt-2 text-sm text-white/70">
                      {item.description}
                    </p>
                    <ul class="mt-4 space-y-2 text-sm text-white/80">
                      {item.bullets.map((bullet) => (
                        <li class="flex items-start gap-2">
                          <span
                            class:list={[
                              "mt-1 h-2 w-2 flex-shrink-0 rounded-full",
                              bulletTone,
                            ]}
                          ></span>
                          <span>{bullet}</span>
                        </li>
                      ))}
                    </ul>
                  </article>
                );
              })}
            </div>
          </div>
        </div>
      </div>
    </section>

    <SectionDivider tone="accent" />

    <div id="planes" aria-hidden="true"></div>
    <PlansSection
      title={plansSection?.title ?? "Planes de desarrollo y tecnologia"}
      description={
        plansSection?.description ??
        "Selecciona la solucion que necesitas hoy y te acompanamos en cada etapa."
      }
      plans={plans ?? []}
    />

    <SectionDivider />

    {casesForPage.length > 0 && <CasesSection cases={casesForPage} />}

    <SectionDivider />

    <ProcessSection />

    <SectionDivider />


    <PortfolioMarqueeSection
      client:visible
      title={portfolioTitle}
      description={portfolioDescription}
      companies={companiesForMarquee}
    />

    <SectionDivider />

    <ContactSection
      content={contactContent}
      whatsappNumber={siteSettings.whatsappNumber}
      sectionId={contactSectionId}
      whatsappMessage={contactWhatsappMessage}
      primaryCtaLabel={contactPrimaryCtaLabel}
      secondaryCtaLabel={contactSecondaryCtaLabel}
      secondaryCtaHref={contactSecondaryCtaHref}
    />
  </main>
  <Footer
    siteSettings={siteSettings}
    navLinks={content.navLinks}
    legalPages={content.legalPages}
  />
  <WhatsAppFloatingButton
    whatsappNumber={siteSettings.whatsappNumber}
    message="Hola! Quiero un desarrollo a medida."
  />
</Layout>
