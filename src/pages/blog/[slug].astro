---
import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/layout/Navbar.astro";
import Footer from "../../components/layout/Footer.astro";
import { fetchAllPosts, fetchSiteSettings } from "../../lib/api/services";
import type { Post } from "../../lib/api/types";
import { env } from "../../lib/env";

export async function getStaticPaths() {
  const posts = await fetchAllPosts({ pageSize: 100 });
  return posts
    .filter((post) => Boolean(post.slug))
    .map((post) => ({ params: { slug: post.slug }, props: { post } }));
}

const { post } = Astro.props as { post: Post };
if (!post) throw new Error("Post not found");

const siteSettings = await fetchSiteSettings();
const pageTitle = post.title || "Blog";
const seoTitle = `${pageTitle} | ${siteSettings.siteName}`;
const publishedDate = post.publishedAt ? new Date(post.publishedAt).toLocaleDateString("es-CL") : "";
const contentParagraphs = post.content ? post.content.split("\n").filter(Boolean) : [];
const siteUrl = env.siteUrl ?? (Astro.site ? Astro.site.toString() : undefined);
const canonical = Astro.url
  ? Astro.url.toString()
  : siteUrl
    ? new URL(`/blog/${post.slug}`, siteUrl).toString()
    : undefined;
const ogImage = post.cover?.url;
const ogImageAlt = post.cover?.alternativeText ?? post.title ?? pageTitle;
const publishedTime = post.publishedAt || post.createdAt;
const modifiedTime = post.updatedAt || post.publishedAt || post.createdAt;
const articleTags = post.tags?.map((tag) => tag.name).filter(Boolean) ?? [];
const articleSection = post.category?.name;
const logoUrl = siteUrl ? new URL("/logo.png", siteUrl).toString() : undefined;
const ogImageAbsolute = ogImage && siteUrl ? new URL(ogImage, siteUrl).toString() : ogImage;
const publisher = {
  "@type": "Organization",
  name: siteSettings.siteName,
  ...(logoUrl ? { logo: { "@type": "ImageObject", url: logoUrl } } : {})
};
const structuredData = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: pageTitle,
  description: post.excerpt,
  ...(canonical ? { mainEntityOfPage: { "@type": "WebPage", "@id": canonical } } : {}),
  ...(ogImageAbsolute ? { image: ogImageAbsolute } : {}),
  ...(publishedTime ? { datePublished: publishedTime } : {}),
  ...(modifiedTime ? { dateModified: modifiedTime } : {}),
  ...(articleSection ? { articleSection } : {}),
  ...(articleTags.length > 0 ? { keywords: articleTags.join(", ") } : {}),
  author: { "@type": "Organization", name: siteSettings.siteName },
  publisher
};
const toAbsolute = (path: string) =>
  siteUrl ? new URL(path, siteUrl).toString() : path;
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "Inicio",
      item: toAbsolute("/"),
    },
    {
      "@type": "ListItem",
      position: 2,
      name: "Blog",
      item: toAbsolute("/blog"),
    },
    {
      "@type": "ListItem",
      position: 3,
      name: pageTitle,
      item: canonical ?? `/blog/${post.slug}`,
    },
  ],
};
---

<Layout
  title={seoTitle}
  description={post.excerpt}
  siteSettings={siteSettings}
  image={ogImage}
  imageAlt={ogImageAlt}
  ogType="article"
  article={{ publishedTime, modifiedTime, section: articleSection, tags: articleTags }}
  structuredData={[structuredData, breadcrumbSchema]}
>
  <Navbar siteSettings={siteSettings} />
  <main class="section-shell py-16 space-y-8">
    <header class="space-y-2 max-w-3xl">
      <p class="pill w-fit bg-primary/10 border-primary/40 text-highlight">Blog</p>
      <h1 class="text-3xl sm:text-4xl font-bold text-content">{post.title}</h1>
      <div class="flex flex-wrap items-center gap-3 text-sm text-muted/80">
        {publishedDate && <span>{publishedDate}</span>}
        {post.category && <span>Categoria: {post.category.name}</span>}
      </div>
      {post.tags && post.tags.length > 0 && (
        <div class="flex flex-wrap gap-2">
          {post.tags.map((tag) => (
            <span class="px-3 py-1 rounded-full bg-surface-strong/40 text-muted text-xs">
              {tag.name}
            </span>
          ))}
        </div>
      )}
      {post.excerpt && <p class="text-muted">{post.excerpt}</p>}
    </header>

    {post.cover?.url && (
      <div class="card overflow-hidden">
        <img src={post.cover.url} alt={post.cover.alternativeText ?? post.title} class="w-full h-96 object-cover" loading="lazy" />
      </div>
    )}

    <article class="prose max-w-3xl text-content prose-headings:text-content prose-p:text-muted prose-a:text-highlight">
      {contentParagraphs.length > 0 ? contentParagraphs.map((text) => <p>{text}</p>) : <p>{post.content}</p>}
    </article>

    <a class="text-sm font-semibold text-highlight hover:text-contrast" href="/blog">Volver al blog</a>
  </main>
  <Footer siteSettings={siteSettings} />
</Layout>
