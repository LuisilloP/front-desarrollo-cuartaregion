---
import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/layout/Navbar.astro";
import Footer from "../../components/layout/Footer.astro";
import { fetchPostsPage, fetchSiteSettings } from "../../lib/api/services";

export const prerender = true;

export async function getStaticPaths() {
  const { pagination } = await fetchPostsPage({ page: 1, pageSize: 6 });
  const totalPages = Math.max(1, pagination.pageCount ?? 1);
  return Array.from({ length: totalPages }, (_, index) => index + 1)
    .filter((pageNumber) => pageNumber > 1)
    .map((pageNumber) => ({ params: { page: pageNumber.toString() } }));
}

const { page } = Astro.params;
const pageNumber = Number(page ?? 1);
const siteSettings = await fetchSiteSettings();
const { data: posts, pagination } = await fetchPostsPage({
  page: pageNumber,
  pageSize: 6,
});
const pageTitle = `Blog - Pagina ${page}`;
const pageLink = (pageNumber: number) =>
  pageNumber <= 1 ? "/blog" : `/blog/${pageNumber}`;
---

<Layout
  title={pageTitle}
  description={siteSettings.tagline}
  siteSettings={siteSettings}
>
  <Navbar siteSettings={siteSettings} />
  <main class="section-shell py-16 space-y-10">
    <header class="space-y-2 max-w-2xl">
      <h1 class="text-3xl sm:text-4xl font-bold text-content">Pagina {page}</h1>
      <p class="text-muted">Explora los ultimos articulos y recursos.</p>
    </header>

    <section class="grid md:grid-cols-2 gap-6">
      {
        posts.map((post) => (
          <article class="card flex flex-col gap-4">
            {post.cover?.url && (
              <img
                src={post.cover.url}
                alt={post.cover.alternativeText ?? post.title}
                class="h-48 w-full object-cover rounded-2xl"
                loading="lazy"
              />
            )}
            <div class="space-y-2">
              <h2 class="text-xl font-semibold text-content">{post.title}</h2>
              {post.excerpt && <p class="text-sm text-muted">{post.excerpt}</p>}
              <a
                class="text-sm font-semibold text-highlight hover:text-contrast"
                href={`/blog/${post.slug}`}
              >
                Leer articulo
              </a>
            </div>
          </article>
        ))
      }
    </section>

    {
      pagination.pageCount > 1 && (
        <nav class="flex items-center gap-3">
          {pagination.page > 1 && (
            <a
              class="text-sm font-semibold text-highlight hover:text-contrast"
              href={pageLink(pagination.page - 1)}
            >
              Anterior
            </a>
          )}
          <span class="text-sm text-muted/80">
            Pagina {pagination.page} de {pagination.pageCount}
          </span>
          {pagination.page < pagination.pageCount && (
            <a
              class="text-sm font-semibold text-highlight hover:text-contrast"
              href={pageLink(pagination.page + 1)}
            >
              Siguiente
            </a>
          )}
        </nav>
      )
    }
  </main>
  <Footer siteSettings={siteSettings} />
</Layout>
