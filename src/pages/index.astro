---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/layout/Navbar.astro";
import Hero from "../components/sections/Hero.astro";
import ServicesSection from "../components/sections/ServicesSection.astro";
import HostingSection from "../components/sections/HostingSection.astro";
import ProcessSection from "../components/sections/ProcessSection.astro";
import CasesSection from "../components/sections/CasesSection.astro";
import FAQSection from "../components/sections/FAQSection.astro";
import ContactSection from "../components/sections/ContactSection.astro";
import Footer from "../components/layout/Footer.astro";
import AboutUs from "../components/sections/AboutUs.astro";
import WhatsAppFloatingButton from "../components/layout/WhatsAppFloatingButton.astro";
import SectionDivider from "../components/layout/SectionDivider.astro";
import BannerCombo from "../components/banners/BannerCombo.astro";
import BannerWeb from "../components/banners/BannerWeb.astro";
import BannerMarketing from "../components/banners/BannerMarketing.astro";
import PromoWeb from "../components/promos/PromoWeb.astro";
import PromoMarketing from "../components/promos/PromoMarketing.astro";
import PromoCombo from "../components/promos/PromoCombo.astro";
import {
  fetchSiteSettings,
  fetchCases,
  fetchFaqs,
} from "../lib/api/services";

import type { Content, HomePageContent, Service } from "../lib/api/types";
import contentJson from "../data/content.json";
import homeJson from "../data/pages/home.json";

// Import the marquee component and its data
import PortfolioMarqueeSection from "../components/sections/PortfolioMarqueeSection.tsx";
import { companies as portfolioCompanies } from "../content/portfolioProjects";

const globalContent = contentJson as Content;
const homeContent = homeJson as HomePageContent;

const { heroSection, useCasesSection, faqSection, contactSection } = homeContent;
const { legalPages, navLinks } = globalContent;
const showProcessSection = false;
const showUseCasesSection = false;

const homeNavLinks = navLinks.filter((link) => {
  const anchor = link.href.replace(/^\/?#/, "");
  if (anchor === "proceso" && !showProcessSection) return false;
  if (anchor === "use-cases" && !showUseCasesSection) return false;
  return true;
});

const planSummaries: Service[] = [
  {
    slug: "planes-desarrollo",
    type: "web",
    variant: "web",
    title: "Planes de desarrollo",
    what_it_solves:
      "Web estática, web administrable o sistemas a medida según tu etapa.",
    benefits: [
      "Web estática profesional",
      "Web administrable",
      "Sistema de gestión a medida",
    ],
    delivery_time: "Según plan",
    modality: "Proyecto",
    price: "Desde $160.000 CLP",
    top_banner: "Desarrollo",
    icon: "lucide:layout",
    whatsapp_desc: "Hola, quiero ver los planes de desarrollo disponibles.",
    ctaLabel: "Ver planes disponibles",
    ctaHref: "/desarrollo#planes",
    order: 1,
  },
  {
    slug: "planes-marketing",
    type: "digital",
    variant: "marketing",
    accent: "amber",
    title: "Planes de marketing",
    what_it_solves:
      "Planes para atraer clientes con campañas, contenido y optimización.",
    benefits: [
      "Meta Ads y Google Ads",
      "Redes sociales y contenido",
      "Embudos y estrategia",
    ],
    delivery_time: "Según plan",
    modality: "Mensual",
    price: "Desde $140.000 CLP",
    top_banner: "Marketing",
    icon: "lucide:rocket",
    whatsapp_desc: "Hola, quiero ver los planes de marketing disponibles.",
    ctaLabel: "Ver planes disponibles",
    ctaHref: "/marketing#planes",
    order: 2,
  },
  {
    slug: "planes-mixto",
    type: "digital",
    variant: "mixed",
    accent: "orange",
    title: "Plan mixto web + marketing",
    what_it_solves: "Combina desarrollo web y campañas para lanzar y convertir.",
    benefits: [
      "Landing optimizada",
      "Campañas con tracking",
      "Reporte y mejoras continuas",
    ],
    delivery_time: "14 días hábiles",
    modality: "Proyecto + Mensual",
    price: "Desde $320.000 CLP",
    top_banner: "Mixto",
    icon: "lucide:layers",
    whatsapp_desc: "Hola, quiero ver los planes mixtos disponibles.",
    ctaLabel: "Hablar por WhatsApp",
    ctaHref: "",
    order: 3,
  },
];

const siteSettings = await fetchSiteSettings();
const cases = await fetchCases();
const faqs = await fetchFaqs();
const recentCases = cases.slice(0, 3);
---

<Layout
  title={siteSettings.siteName}
  description={siteSettings.tagline}
  siteSettings={siteSettings}
>
  <Navbar siteSettings={siteSettings} navLinks={homeNavLinks} />
  <main class="space-y-8 overflow-x-hidden max-w-full">
    <Hero siteSettings={siteSettings} content={heroSection} />

    <section class="section-shell py-4 sm:py-6" aria-labelledby="promos-heading">
      <div class="mb-4 sm:mb-5">
        <p
          id="promos-heading"
          class="inline-flex items-center rounded-full border border-primary/20 bg-primary/5 px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.24em] text-primary/80"
        >
          Accesos rápidos
        </p>
      </div>

      <div class="mt-3 sm:mt-4 grid gap-3 sm:gap-4 lg:grid-cols-3">
        <PromoWeb />
        <PromoMarketing />
        <PromoCombo />
      </div>
      <div class="mt-3 sm:mt-4 grid gap-3 sm:gap-4 lg:grid-cols-2">
        <PromoWeb />
        <PromoMarketing />
      </div>
      <div class="mt-3 sm:mt-4">
        <PromoCombo />
      </div>
    </section>

    <section class="section-shell space-y-6 py-4 sm:py-6 lg:py-8">
      <BannerCombo />
      <BannerCombo
        title="Web + Marketing que convierte"
        subtitle="Landing, captacion y seguimiento conectados en un solo flujo"
        description="Integramos diseno, mensaje y pauta para que tu inversion tenga foco comercial desde el inicio."
        badgeText="Todo en un plan"
        primaryLink={{ label: "Hablar por WhatsApp", href: "#contacto-marketing" }}
        secondaryLink={{ label: "Agendar llamada", href: "#contacto-marketing" }}
        bullets={[
          "Oferta clara para captar mejores leads",
          "Embudo digital con medicion real",
          "Optimizacion continua por resultados",
        ]}
        reverse
      />
      <BannerWeb />
      <BannerMarketing />
    </section>

    <div id="planes-web" aria-hidden="true"></div>
    <div id="planes-marketing" aria-hidden="true"></div>
    <div id="planes-combo" aria-hidden="true"></div>
    <div id="planes" aria-hidden="true"></div>

    {/* Show summary cards for each plan group */}
    <ServicesSection
      services={planSummaries}
      whatsappNumber={siteSettings.whatsappNumber}
      singleGrid
    />

    <SectionDivider tone="accent" />

    {/* Social proof early - Cases show we deliver results */}
    <CasesSection cases={recentCases} />

    <SectionDivider />

    {/* How we work - Premium process section */}
    {showProcessSection ? <ProcessSection /> : null}

    <SectionDivider />

    {/* More social proof - Portfolio companies */}
    <PortfolioMarqueeSection client:visible companies={portfolioCompanies} />

    <SectionDivider />

    {/* About Us after user is already interested */}
    <AboutUs />

    <SectionDivider />

    {/* Why choose us - Reinforcement */}
    {showUseCasesSection ? <HostingSection content={useCasesSection} /> : null}

    <SectionDivider />

    {/* FAQ - Handle objections */}
    <FAQSection content={faqSection} faqs={faqs} />

    <SectionDivider />

    {/* Final CTA */}
    <ContactSection
      content={contactSection}
      whatsappNumber={siteSettings.whatsappNumber}
    />
  </main>
  <Footer
    siteSettings={siteSettings}
    navLinks={navLinks}
    legalPages={legalPages}
  />
  <WhatsAppFloatingButton
    whatsappNumber={siteSettings.whatsappNumber}
    message="Hola, me gustaría orientación para un proyecto web."
  />
</Layout>
