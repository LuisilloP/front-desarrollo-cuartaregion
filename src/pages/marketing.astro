---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/layout/Navbar.astro";
import Footer from "../components/layout/Footer.astro";
import WhatsAppFloatingButton from "../components/layout/WhatsAppFloatingButton.astro";
import MarketingHero from "../components/marketing/MarketingHero.astro";
import PlansSection from "../components/marketing/PlansSection.astro";
import HostingSection from "../components/sections/HostingSection.astro";
import ProcessSection from "../components/sections/ProcessSection.astro";
import CasesSection from "../components/sections/CasesSection.astro";
import PortfolioMarqueeSection from "../components/sections/PortfolioMarqueeSection.tsx";
import ContactSection from "../components/sections/ContactSection.astro";
import { fetchCases, fetchSiteSettings } from "../lib/api/services";
import type { CaseStudy, Content, MarketingPageContent } from "../lib/api/types";
import type { Company } from "../content/portfolioProjects";
import contentJson from "../data/content.json";
import marketingJson from "../data/pages/marketing.json";
import marketingClientsJson from "../data/pages/marketing-clients.json";
import marketingCasesJson from "../data/pages/marketing-cases.json";
import { env } from "../lib/env";

const siteSettings = await fetchSiteSettings();
const allCases = await fetchCases();
const content = contentJson as Content;
const marketingContent = marketingJson as MarketingPageContent;
const marketingClients = marketingClientsJson as {
  title?: string;
  description?: string;
  companies: Company[];
};
const marketingCases = (marketingCasesJson.slugs ?? [])
  .map((slug) => allCases.find((item) => item.slug === slug))
  .filter((item): item is CaseStudy => Boolean(item));

const {
  hero,
  value,
  seo,
  plansSection,
  contactSection,
  useCasesSection,
  processSection,
} = marketingContent;
const pageTitle = seo?.title ?? "Marketing Digital para Pymes | Aliado Digital";
const pageDescription =
  seo?.description ??
  "Campañas de Meta Ads y Google Ads con estrategia y medición. Marketing digital para pymes en Chile.";

const contactContent = {
  eyebrow: contactSection?.eyebrow ?? "Hablemos",
  title: contactSection?.title ?? "Hablemos de tu marketing",
  description:
    contactSection?.description ??
    "Cuéntanos tu objetivo y te proponemos una estrategia clara para atraer más clientes.",
  socialLinks: contactSection?.socialLinks ?? content.siteSettings.socialLinks,
};

const contactSectionId = contactSection?.sectionId ?? "contacto-marketing";
const contactWhatsappMessage =
  contactSection?.whatsappMessage ??
  "Hola! Quiero atraer más clientes con marketing digital.";
const contactPrimaryCtaLabel =
  contactSection?.primaryCtaLabel ?? "Contactar por WhatsApp";
const contactSecondaryCtaLabel =
  contactSection?.secondaryCtaLabel ?? "Completar diagnóstico";
const contactSecondaryCtaHref =
  contactSection?.secondaryCtaHref ?? "https://forms.gle/5MEDYUSc2pZpS4tz8";

const marketingServices = (content.services ?? [])
  .filter((service) => service.variant === "marketing")
  .sort((a, b) => (a.order ?? 99) - (b.order ?? 99));

const siteUrl = env.siteUrl ?? (Astro.site ? Astro.site.toString() : undefined);
const canonical = Astro.url
  ? Astro.url.toString()
  : siteUrl
    ? new URL("/marketing", siteUrl).toString()
    : undefined;
const logoUrl = siteUrl ? new URL("/logo.png", siteUrl).toString() : undefined;
const provider = {
  "@type": "Organization",
  name: siteSettings.siteName,
  ...(siteUrl ? { url: siteUrl } : {}),
  ...(logoUrl ? { logo: { "@type": "ImageObject", url: logoUrl } } : {}),
};
const toAbsolute = (path: string) =>
  siteUrl ? new URL(path, siteUrl).toString() : path;
const areaServedItems = [
  ...(siteSettings.region
    ? [{ "@type": "Place", name: siteSettings.region }]
    : []),
  { "@type": "Country", name: "Chile" },
];
const areaServed =
  areaServedItems.length === 1 ? areaServedItems[0] : areaServedItems;
const marketingOfferItems = marketingServices.map((service) => ({
  "@type": "Offer",
  itemOffered: {
    "@type": "Service",
    name: service.title,
    description: service.what_it_solves,
    serviceType: service.title,
  },
}));
const marketingServiceSchema = {
  "@context": "https://schema.org",
  "@type": "Service",
  name: "Marketing digital para pymes",
  description: pageDescription,
  serviceType: "Marketing digital",
  ...(canonical ? { url: canonical } : {}),
  ...(areaServed ? { areaServed } : {}),
  provider,
  ...(marketingOfferItems.length > 0
    ? {
        hasOfferCatalog: {
          "@type": "OfferCatalog",
          name: "Servicios de marketing digital",
          itemListElement: marketingOfferItems,
        },
      }
    : {}),
};
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "Inicio",
      item: toAbsolute("/"),
    },
    {
      "@type": "ListItem",
      position: 2,
      name: "Marketing",
      item: canonical ?? "/marketing",
    },
  ],
};
---

<Layout
  title={pageTitle}
  description={pageDescription}
  siteSettings={siteSettings}
  structuredData={[marketingServiceSchema, breadcrumbSchema]}
>
  <Navbar
    siteSettings={siteSettings}
    navLinks={content.navLinks}
    forceTransparent
  />
  <main class="overflow-x-hidden">
    <MarketingHero hero={hero} value={value} />

     <PlansSection
      title={plansSection?.title ?? "Planes de marketing digital"}
      description={
        plansSection?.description ??
        "Elige el plan que mejor se ajuste a tu etapa. Todos priorizan resultados reales y crecimiento sostenido."
      }
    />

    {marketingCases.length > 0 && (
      <CasesSection cases={marketingCases} origin="marketing" />
    )}

    {processSection && (
      <ProcessSection
        sectionId={processSection.sectionId}
        title={processSection.title}
        description={processSection.description}
        steps={processSection.steps}
      />
    )}

    <!-- {useCasesSection && <HostingSection content={useCasesSection} />} -->

    <PortfolioMarqueeSection
      client:visible
      title={marketingClients.title}
      description={marketingClients.description}
      companies={marketingClients.companies}
    />

    <ContactSection
      content={contactContent}
      whatsappNumber={siteSettings.whatsappNumber}
      sectionId={contactSectionId}
      whatsappMessage={contactWhatsappMessage}
      primaryCtaLabel={contactPrimaryCtaLabel}
      secondaryCtaLabel={contactSecondaryCtaLabel}
      secondaryCtaHref={contactSecondaryCtaHref}
    />
  </main>
  <Footer
    siteSettings={siteSettings}
    navLinks={content.navLinks}
    legalPages={content.legalPages}
  />
  <WhatsAppFloatingButton
    whatsappNumber={siteSettings.whatsappNumber}
    message="Hola! Quiero atraer más clientes con marketing digital."
  />
</Layout>
