---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/layout/Navbar.astro";
import Footer from "../components/layout/Footer.astro";
import SectionDivider from "../components/layout/SectionDivider.astro";
import WhatsAppFloatingButton from "../components/layout/WhatsAppFloatingButton.astro";
import MarketingHero from "../components/marketing/MarketingHero.astro";
import PlansSection from "../components/marketing/PlansSection.astro";
import HostingSection from "../components/sections/HostingSection.astro";
import ProcessSection from "../components/sections/ProcessSection.astro";
import CasesSection from "../components/sections/CasesSection.astro";
import PortfolioMarqueeSection from "../components/sections/PortfolioMarqueeSection.tsx";
import ContactSection from "../components/sections/ContactSection.astro";
import { fetchCases, fetchSiteSettings } from "../lib/api/services";
import type { CaseStudy, Content, MarketingPageContent } from "../lib/api/types";
import type { Company } from "../content/portfolioProjects";
import contentJson from "../data/content.json";
import marketingJson from "../data/pages/marketing.json";
import marketingClientsJson from "../data/pages/marketing-clients.json";
import marketingCasesJson from "../data/pages/marketing-cases.json";

const siteSettings = await fetchSiteSettings();
const allCases = await fetchCases();
const content = contentJson as Content;
const marketingContent = marketingJson as MarketingPageContent;
const marketingClients = marketingClientsJson as {
  title?: string;
  description?: string;
  companies: Company[];
};
const marketingCases = (marketingCasesJson.slugs ?? [])
  .map((slug) => allCases.find((item) => item.slug === slug))
  .filter((item): item is CaseStudy => Boolean(item));

const {
  hero,
  value,
  seo,
  plansSection,
  contactSection,
  useCasesSection,
  processSection,
} = marketingContent;
const pageTitle = seo?.title ?? "Marketing Digital para Pymes | Aliado Digital";
const pageDescription =
  seo?.description ??
  "Marketing digital enfocado en resultados reales para pymes, profesionales y negocios locales de Chile.";

const contactContent = {
  eyebrow: contactSection?.eyebrow ?? "Hablemos",
  title: contactSection?.title ?? "Hablemos de tu marketing",
  description:
    contactSection?.description ??
    "Cuentanos tu objetivo y te proponemos una estrategia clara para atraer mas clientes.",
  socialLinks: contactSection?.socialLinks ?? content.siteSettings.socialLinks,
};

const contactSectionId = contactSection?.sectionId ?? "contacto-marketing";
const contactWhatsappMessage =
  contactSection?.whatsappMessage ??
  "Hola! Quiero atraer mas clientes con marketing digital.";
const contactPrimaryCtaLabel =
  contactSection?.primaryCtaLabel ?? "Contactar por WhatsApp";
const contactSecondaryCtaLabel =
  contactSection?.secondaryCtaLabel ?? "Completar diagnostico";
const contactSecondaryCtaHref =
  contactSection?.secondaryCtaHref ?? "https://forms.gle/5MEDYUSc2pZpS4tz8";
---

<Layout
  title={pageTitle}
  description={pageDescription}
  siteSettings={siteSettings}
>
  <Navbar
    siteSettings={siteSettings}
    navLinks={content.navLinks}
    forceTransparent
  />
  <main class="overflow-x-hidden">
    <MarketingHero hero={hero} value={value} />

    <SectionDivider />

    <PlansSection
      title={plansSection?.title ?? "Planes de marketing digital"}
      description={
        plansSection?.description ??
        "Elige el plan que mejor se ajuste a tu etapa. Todos priorizan resultados reales y crecimiento sostenido."
      }
    />

    <SectionDivider />

    {useCasesSection && <HostingSection content={useCasesSection} />}

    <SectionDivider />

    {processSection && (
      <ProcessSection
        sectionId={processSection.sectionId}
        title={processSection.title}
        description={processSection.description}
        steps={processSection.steps}
      />
    )}

    <SectionDivider />

    {marketingCases.length > 0 && (
      <CasesSection cases={marketingCases} origin="marketing" />
    )}

    <SectionDivider />

    <PortfolioMarqueeSection
      client:visible
      title={marketingClients.title}
      description={marketingClients.description}
      companies={marketingClients.companies}
    />

    <SectionDivider />

    <ContactSection
      content={contactContent}
      whatsappNumber={siteSettings.whatsappNumber}
      sectionId={contactSectionId}
      whatsappMessage={contactWhatsappMessage}
      primaryCtaLabel={contactPrimaryCtaLabel}
      secondaryCtaLabel={contactSecondaryCtaLabel}
      secondaryCtaHref={contactSecondaryCtaHref}
    />
  </main>
  <Footer
    siteSettings={siteSettings}
    navLinks={content.navLinks}
    legalPages={content.legalPages}
  />
  <WhatsAppFloatingButton
    whatsappNumber={siteSettings.whatsappNumber}
    message="Hola! Quiero atraer mÃ¡s clientes con marketing digital."
  />
</Layout>
