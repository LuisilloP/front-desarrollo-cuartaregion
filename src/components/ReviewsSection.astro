---
import type { Review } from "../data/mock";
import { Icon } from "astro-icon/components";

interface Props {
  reviews: Review[];
}

const { reviews } = Astro.props;
const sortedReviews = [...reviews].sort(
  (a, b) => (a.order ?? 0) - (b.order ?? 0)
);

const getInitials = (name: string) => {
  const cleaned = (name ?? "").trim();
  if (!cleaned) return "";
  const parts = cleaned.split(/\s+/);
  const first = parts[0]?.[0] ?? "";
  const last = parts.length > 1 ? (parts[parts.length - 1]?.[0] ?? "") : "";
  return `${first}${last}`.toUpperCase();
};

const stars = Array.from({ length: 5 });
---

<section id="resenas" class="py-20 space-y-8" data-animate="reveal">
  <div class="section-shell flex flex-col gap-3 max-w-3xl">
    <p class="pill inline-flex items-center gap-2 w-fit border border-border/70 bg-card text-content shadow-soft">
      <Icon name="lucide:star" class="h-4 w-4 text-highlight" />
      Testimonios reales
    </p>
    <h2 class="text-3xl sm:text-4xl font-bold text-content">Opiniones de clientes</h2>
    <p class="text-muted">
      Negocios que hoy venden mas y atienden mejor con procesos digitales claros.
    </p>
  </div>
  <div
    class="section-shell grid gap-6 [grid-template-columns:repeat(auto-fit,minmax(260px,1fr))]"
  >
    {
      sortedReviews.map((item) => {
        const initials = getInitials(item.clientName);
        const ratingValue = typeof item.rating === "number" ? item.rating : 0;
        const rating = Math.max(0, Math.min(5, Math.round(ratingValue)));

        return (
          <article class="group relative flex h-full flex-col gap-4 overflow-hidden rounded-3xl border border-border/70 bg-card p-6 shadow-soft transition duration-300 hover:-translate-y-1 hover:border-primary/40">
            <div class="relative flex items-center justify-between gap-3">
              <div class="flex items-center gap-3">
                <div class="flex h-11 w-11 items-center justify-center rounded-full bg-gradient-to-br from-primary/70 to-accent/70 text-secondary text-sm font-semibold">
                  {initials}
                </div>
                <div>
                  <p class="text-base font-semibold text-content">
                    {item.clientName}
                  </p>
                  <p class="text-xs uppercase tracking-wide text-muted">
                    {item.business}
                  </p>
                </div>
              </div>
              <span
                class="inline-flex items-center gap-1 rounded-full border border-amber-300 bg-amber-50 px-2 py-1 text-[11px] font-semibold text-amber-600 shadow-sm dark:border-amber-200/40 dark:bg-amber-200/15 dark:text-amber-50"
                aria-label={`Rating ${ratingValue} de 5`}
              >
                <svg
                  viewBox="0 0 24 24"
                  fill="currentColor"
                  class="h-3 w-3"
                  aria-hidden="true"
                >
                  <path d="M12 2.5l2.9 6 6.6.9-4.8 4.5 1.2 6.5L12 17.8 6.1 20.4l1.2-6.5-4.8-4.5 6.6-.9L12 2.5z" />
                </svg>
                {ratingValue.toFixed(1)}
              </span>
            </div>
            <blockquote class="relative text-sm leading-relaxed text-muted">
              <p class="pl-6 italic text-content">&ldquo;{item.quote}&rdquo;</p>
            </blockquote>
          </article>
        );
      })
    }
  </div>
</section>
