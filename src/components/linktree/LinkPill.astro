---
import Icon from "./Icon.astro";
import {
  resolveTokens,
  type LinkPillVariant,
} from "../../lib/linktreeTokens";

type IconPosition = "left" | "right";
type LinkTarget = "_blank" | "_self";

interface Props {
  label: string;
  href?: string;
  variant?: LinkPillVariant;
  accentKey?: string;
  icon?: string;
  iconImageSrc?: string;
  iconImageAlt?: string;
  iconPosition?: IconPosition;
  description?: string;
  target?: LinkTarget;
  rel?: string;
  class?: string;
}

const iconNamePattern = /^(lucide|simple-icons|mdi):[a-z0-9-]+$/i;
const iconImagePattern = /^(\/(?!\/)|https?:\/\/)/i;
const safeHrefPattern = /^(\/(?!\/)|#|https?:\/\/|mailto:|tel:)/i;

const {
  label,
  href,
  variant = "neutral",
  accentKey,
  icon,
  iconImageSrc,
  iconImageAlt,
  iconPosition = "left",
  description,
  target,
  rel,
  class: className = "",
} = Astro.props as Props;

const safeLabel = label.trim();
const normalizedHref = typeof href === "string" ? href.trim() : "";
const hasHref = normalizedHref.length > 0 && safeHrefPattern.test(normalizedHref);
const normalizedDescription =
  typeof description === "string" ? description.trim() : "";
const hasDescription = normalizedDescription.length > 0;
const externalByHref = /^https?:\/\//i.test(normalizedHref);
const resolvedTarget = hasHref
  ? target ?? (externalByHref ? "_blank" : "_self")
  : undefined;
const resolvedRel =
  hasHref && resolvedTarget === "_blank" ? rel ?? "noopener noreferrer" : rel;
const resolvedTokens = resolveTokens(variant, accentKey);
const normalizedIcon = typeof icon === "string" ? icon.trim() : "";
const safeIcon = iconNamePattern.test(normalizedIcon) ? normalizedIcon : "";
const normalizedIconImageSrc =
  typeof iconImageSrc === "string" ? iconImageSrc.trim() : "";
const safeIconImageSrc = iconImagePattern.test(normalizedIconImageSrc)
  ? normalizedIconImageSrc
  : "";
const safeIconImageAlt =
  typeof iconImageAlt === "string" ? iconImageAlt.trim() : "";
const hasVisualIcon = Boolean(safeIcon || safeIconImageSrc);
---

{
  hasHref ? (
    <a
      href={normalizedHref}
      target={resolvedTarget}
      rel={resolvedRel}
      aria-label={hasDescription ? `${safeLabel}. ${normalizedDescription}` : safeLabel}
      class:list={[
        "group relative flex min-h-14 w-full items-center gap-3 overflow-hidden rounded-2xl border px-4 py-3",
        "shadow-[0_14px_30px_rgba(15,23,42,0.16)] backdrop-blur-xl",
        "transition-all duration-200 hover:-translate-y-0.5 active:translate-y-px",
        "motion-reduce:transition-none motion-reduce:hover:translate-y-0 motion-reduce:active:translate-y-0",
        "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-100 dark:focus-visible:ring-offset-slate-950",
        resolvedTokens.background,
        resolvedTokens.border,
        resolvedTokens.hover,
        resolvedTokens.focus,
        className,
      ]}
    >
      <span aria-hidden="true" class="link-pill-glow"></span>

      {hasVisualIcon && iconPosition === "left" ? (
        <span
          class:list={[
            "inline-flex h-10 w-10 shrink-0 items-center justify-center rounded-xl border",
            resolvedTokens.iconWrap,
          ]}
        >
          {safeIconImageSrc ? (
            <img
              src={safeIconImageSrc}
              alt={safeIconImageAlt}
              class="h-[19px] w-[19px] rounded-sm object-contain"
              loading="lazy"
              decoding="async"
            />
          ) : (
            <Icon
              name={safeIcon}
              size={19}
              class:list={["h-[19px] w-[19px]", resolvedTokens.iconColor]}
            />
          )}
        </span>
      ) : null}

      <span class="min-w-0 flex-1">
        <span class="block truncate text-[0.98rem] font-semibold leading-tight sm:text-base">
          {safeLabel}
        </span>
        {hasDescription ? (
          <span class="mt-0.5 block text-xs leading-relaxed text-slate-700 dark:text-slate-300/90">
            {normalizedDescription}
          </span>
        ) : null}
      </span>

      {hasVisualIcon && iconPosition === "right" ? (
        <span
          class:list={[
            "inline-flex h-10 w-10 shrink-0 items-center justify-center rounded-xl border",
            resolvedTokens.iconWrap,
          ]}
        >
          {safeIconImageSrc ? (
            <img
              src={safeIconImageSrc}
              alt={safeIconImageAlt}
              class="h-[19px] w-[19px] rounded-sm object-contain"
              loading="lazy"
              decoding="async"
            />
          ) : (
            <Icon
              name={safeIcon}
              size={19}
              class:list={["h-[19px] w-[19px]", resolvedTokens.iconColor]}
            />
          )}
        </span>
      ) : null}

      <span
        class:list={[
          "inline-flex h-8 w-8 shrink-0 items-center justify-center rounded-full border transition-transform duration-200 group-hover:translate-x-0.5 group-focus-visible:translate-x-0.5 motion-reduce:transition-none",
          resolvedTokens.iconWrap,
        ]}
      >
        <Icon
          name="lucide:chevron-right"
          size={15}
          class:list={[
            "h-[15px] w-[15px]",
            resolvedTokens.chevron,
          ]}
        />
      </span>
    </a>
  ) : (
    <div
      role="group"
      aria-disabled="true"
      aria-label={`${safeLabel} (no disponible)`}
      class:list={[
        "relative flex min-h-14 w-full items-center gap-3 rounded-2xl border px-4 py-3",
        "cursor-not-allowed opacity-65 saturate-50",
        "shadow-[0_10px_22px_rgba(15,23,42,0.12)] backdrop-blur-xl",
        "bg-white/72 border-slate-300/60 dark:bg-slate-900/62 dark:border-slate-700/55",
        className,
      ]}
    >
      {hasVisualIcon ? (
        <span class="inline-flex h-10 w-10 shrink-0 items-center justify-center rounded-xl border border-slate-300/65 bg-slate-100/82 dark:border-slate-600/55 dark:bg-slate-800/72">
          {safeIconImageSrc ? (
            <img
              src={safeIconImageSrc}
              alt={safeIconImageAlt}
              class="h-[19px] w-[19px] rounded-sm object-contain"
              loading="lazy"
              decoding="async"
            />
          ) : (
            <Icon
              name={safeIcon}
              size={19}
              class="h-[19px] w-[19px] text-slate-500 dark:text-slate-400"
            />
          )}
        </span>
      ) : null}

      <span class="min-w-0 flex-1">
        <span class="block truncate text-[0.98rem] font-semibold leading-tight text-slate-700 dark:text-slate-300 sm:text-base">
          {safeLabel}
        </span>
        {hasDescription ? (
          <span class="mt-0.5 block text-xs leading-relaxed text-slate-600 dark:text-slate-400">
            {normalizedDescription}
          </span>
        ) : null}
      </span>

      <span class="inline-flex h-8 w-8 shrink-0 items-center justify-center rounded-full border border-slate-300/70 bg-white/70 dark:border-slate-700/55 dark:bg-slate-800/78">
        <Icon
          name="lucide:minus"
          size={14}
          class="h-3.5 w-3.5 text-slate-400 dark:text-slate-500"
          aria-hidden="true"
        />
      </span>
    </div>
  )
}

<style>
  .link-pill-glow {
    position: absolute;
    inset: -1px;
    border-radius: inherit;
    pointer-events: none;
    opacity: 0;
    background:
      radial-gradient(
        120% 85% at 20% 0%,
        rgb(56 189 248 / 0.2) 0%,
        transparent 70%
      ),
      radial-gradient(
        100% 80% at 100% 100%,
        rgb(251 146 60 / 0.18) 0%,
        transparent 72%
      );
    transition: opacity 240ms ease;
    animation: link-pill-glow-float 7s ease-in-out infinite;
  }

  a.group:hover .link-pill-glow,
  a.group:focus-visible .link-pill-glow {
    opacity: 1;
  }

  :global(.dark) .link-pill-glow {
    background:
      radial-gradient(
        120% 85% at 20% 0%,
        rgb(56 189 248 / 0.16) 0%,
        transparent 70%
      ),
      radial-gradient(
        100% 80% at 100% 100%,
        rgb(251 146 60 / 0.14) 0%,
        transparent 72%
      );
  }

  @keyframes link-pill-glow-float {
    0% {
      transform: translate3d(0, 0, 0) scale(1);
    }
    50% {
      transform: translate3d(2px, -1px, 0) scale(1.01);
    }
    100% {
      transform: translate3d(-2px, 1px, 0) scale(0.995);
    }
  }
</style>
