---
import type { SiteSettings } from "../data/mock";
import { buildWhatsAppLink } from "../lib/utils";
import { Icon } from "astro-icon/components";

interface Props {
  siteSettings: SiteSettings;
}

const { siteSettings } = Astro.props;
const whatsappUrl = buildWhatsAppLink(siteSettings.whatsappNumber, "Hola, quiero cotizar mi sitio o automatizacion.");
const formEndpoint = "/api/contact";
---

<section id="contacto" class="py-20" data-animate="reveal">
  <div class="section-shell grid lg:grid-cols-2 gap-10 items-start">
    <div class="space-y-4">
      <p class="pill inline-flex items-center gap-2 w-fit border border-border/70 bg-card text-content shadow-soft">
        <Icon name="lucide:message-circle" class="h-4 w-4 text-highlight" />
        Contacto
      </p>
      <h2 class="text-3xl sm:text-4xl font-bold text-content">Conversemos y armamos tu plan</h2>
      <p class="text-muted">
        Cuentanos si necesitas una landing de alto rendimiento, automatizar WhatsApp o soporte TI continuo. Respondemos en menos de
        24h habiles con una propuesta inicial y tiempos claros.
      </p>
      <a
        href={whatsappUrl}
        target="_blank"
        rel="noreferrer"
        class="inline-flex items-center gap-3 px-5 py-3 rounded-full bg-[#25D366] text-white font-semibold shadow-soft hover:shadow-lg transition"
      >
        <Icon name="simple-icons:whatsapp" class="h-4 w-4 text-white" aria-hidden="true" />
        Hablar por WhatsApp
        <span aria-hidden="true">-></span>
      </a>
      <div class="card text-sm text-muted">
        <p class="font-semibold text-content mb-2">Que pasa despues?</p>
        <p>
          Revisamos tu mensaje, proponemos alcance y entregables, y coordinamos una llamada breve si hace falta. Todo queda por
          escrito antes de iniciar.
        </p>
      </div>
    </div>
    <form class="card bg-card border-border space-y-4" method="post" action={formEndpoint} data-endpoint={formEndpoint}>
      <div>
        <label for="name" class="block text-sm font-medium text-content mb-1">Nombre</label>
        <input
          id="name"
          name="name"
          required
          class="w-full rounded-xl bg-card border border-border text-content px-4 py-3 focus:outline-none focus:ring-2 focus:ring-highlight placeholder:text-muted/80"
          placeholder="Tu nombre o negocio"
        />
      </div>
      <div>
        <label for="contact" class="block text-sm font-medium text-content mb-1">Correo o telefono</label>
        <input
          id="contact"
          name="contact"
          type="text"
          required
          class="w-full rounded-xl bg-card border border-border text-content px-4 py-3 focus:outline-none focus:ring-2 focus:ring-highlight placeholder:text-muted/80"
          placeholder="tucorreo@empresa.cl / +569..."
        />
      </div>
      <div>
        <label for="message" class="block text-sm font-medium text-content mb-1">Mensaje</label>
        <textarea
          id="message"
          name="message"
          rows="4"
          required
          class="w-full rounded-xl bg-card border border-border text-content px-4 py-3 focus:outline-none focus:ring-2 focus:ring-highlight placeholder:text-muted/80"
          placeholder="Cuentanos que necesitas"
        ></textarea>
      </div>
      <button
        type="submit"
        class="w-full inline-flex items-center justify-center gap-2 px-5 py-3 rounded-full bg-gradient-to-r from-primary to-accent text-secondary font-semibold shadow-soft hover:shadow-lg transition"
      >
        Enviar consulta
      </button>
      <p class="text-xs text-muted/80">
        Al enviar aceptas nuestra <a class="underline" href="/privacidad">politica de privacidad</a>.
      </p>
    </form>
  </div>
  <script is:inline>
    const form = document.currentScript?.previousElementSibling as HTMLFormElement | null;
    if (form) {
      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const endpoint = form.dataset.endpoint ?? form.action;
        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());
        try {
          await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          alert("Consulta enviada. Te contactaremos pronto.");
          form.reset();
        } catch (err) {
          alert("No se pudo enviar. Intentalo de nuevo o escribe por WhatsApp.");
          console.error(err);
        }
      });
    }
  </script>
</section>
