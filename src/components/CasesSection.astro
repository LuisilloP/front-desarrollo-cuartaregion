---
import type { CaseStudy } from "../data/mock";
import { Icon } from "astro-icon/components";

interface Props {
  cases: CaseStudy[];
}

const { cases } = Astro.props;
const sortedCases = [...cases].sort((a, b) => (a.order ?? 0) - (b.order ?? 0));

const getText = (value: unknown) => (typeof value === "string" ? value.trim() : "");
const getSummary = (item: CaseStudy) => {
  const summary = getText(item.summary);
  if (summary) return summary;
  const before = item.beforePoints?.find((point) => point?.text)?.text ?? "";
  if (before) return before;
  const after = item.afterPoints?.find((point) => point?.text)?.text ?? "";
  if (after) return after;
  if (Array.isArray(item.problem)) return item.problem[0] ?? "";
  if (typeof item.problem === "string") return item.problem;
  return "";
};
---

<section id="casos" class="py-20 space-y-10" data-animate="reveal">
  <div class="section-shell flex flex-col gap-3 max-w-3xl">
    <p class="pill inline-flex items-center gap-2 w-fit border border-border/70 bg-card/80 text-content shadow-soft backdrop-blur-sm">
      <Icon name="lucide:bar-chart-3" class="h-4 w-4 text-highlight" />
      Casos reales
    </p>
    <h2 class="text-3xl sm:text-4xl font-bold text-content">
      Resultados medibles con empresas locales
    </h2>
    <p class="text-muted">
      Webs, reservas y automatizaciones que reducen friccion y suben conversiones.
    </p>
  </div>

  <div class="section-shell grid gap-6 md:grid-cols-2 lg:grid-cols-3">
    {sortedCases.map((item) => {
      const title = getText(item.title) || item.clientName || getText(item.summary) || "Caso";
      const summary = getSummary(item);
      const industry = getText(item.industry);
      const city = getText(item.city);
      const coverAlt = item.coverImageAlt || `Caso ${item.clientName || title}`;
      const hasMeta = Boolean(industry || city);
      const isFeatured = Boolean(item.featured);
      const href = `/casos/${item.slug}`;

      return (
        <article class="group relative flex h-full flex-col overflow-hidden rounded-3xl border border-border/70 bg-card shadow-soft transition duration-300 hover:-translate-y-1 hover:shadow-xl">
          <a href={href} class="flex h-full flex-col" aria-label={`Ver caso ${title}`}>
            <div class="relative aspect-[16/9] w-full overflow-hidden bg-surface-strong/30">
              {item.coverImage ? (
                <img
                  src={item.coverImage}
                  alt={coverAlt}
                  loading="lazy"
                  class="h-full w-full object-cover object-center scale-105 transition duration-300 group-hover:scale-110"
                />
              ) : (
                <div class="h-full w-full bg-gradient-to-br from-primary/20 via-surface-strong/50 to-accent/20"></div>
              )}

              {isFeatured && (
                <span class="absolute left-4 top-4 inline-flex items-center rounded-full border border-primary/40 bg-primary/10 px-3 py-1 text-[11px] font-semibold text-primary">
                  Destacado
                </span>
              )}
            </div>

            <div class="flex flex-1 flex-col gap-4 p-6">
              <div class="space-y-1">
                {item.clientName && <p class="text-xs font-semibold text-highlight">{item.clientName}</p>}
                <h3 class="text-xl font-semibold text-content">{title}</h3>
              </div>

              {summary && <p class="text-sm leading-relaxed text-muted">{summary}</p>}

              <div class="mt-auto space-y-3">
                <div class="flex items-center justify-between border-t border-border/70 pt-3 text-xs font-semibold text-muted/80">
                  <div class="flex flex-wrap items-center gap-3">
                    {industry && (
                      <span class="inline-flex items-center gap-2">
                        <svg viewBox="0 0 24 24" fill="none" class="h-4 w-4" aria-hidden="true">
                          <path
                            d="M4 20V4h10v16M14 20V8h6v12M3 20h18"
                            stroke="currentColor"
                            stroke-width="1.6"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          />
                        </svg>
                        {industry}
                      </span>
                    )}
                    {city && (
                      <span class="inline-flex items-center gap-2">
                        <svg viewBox="0 0 24 24" fill="none" class="h-4 w-4" aria-hidden="true">
                          <path
                            d="M12 21s6-6.4 6-11a6 6 0 1 0-12 0c0 4.6 6 11 6 11z"
                            stroke="currentColor"
                            stroke-width="1.6"
                          />
                          <circle cx="12" cy="10" r="2.5" stroke="currentColor" stroke-width="1.6" />
                        </svg>
                        {city}
                      </span>
                    )}
                    {!hasMeta && <span>Ver caso</span>}
                  </div>
                  <span class="inline-flex items-center text-muted/70 transition group-hover:text-highlight">
                    <svg viewBox="0 0 24 24" fill="none" class="h-4 w-4" aria-hidden="true">
                      <path d="M8 5l8 7-8 7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
                    </svg>
                  </span>
                </div>

                <span class="inline-flex w-full items-center justify-center rounded-full border border-border/70 bg-card px-4 py-2 text-sm font-semibold text-muted transition group-hover:border-primary/40 group-hover:text-primary">
                  Ver mas detalles
                </span>
              </div>
            </div>
          </a>
        </article>
      );
    })}
  </div>
</section>
