---
import { Icon } from "astro-icon/components";
import type { SiteSettings, NavLink, Content } from "../../lib/api/types";
import contentJson from "../../data/content.json";

interface Props {
  siteSettings: SiteSettings;
  navLinks?: NavLink[];
}

const content = contentJson as Content;
const fallbackNavLinks = content.navLinks ?? [];
const { siteSettings, navLinks = fallbackNavLinks } = Astro.props;
const pathname = Astro.url?.pathname ?? "/";
const isHome = pathname === "/" || pathname === "";
const withHome = (href: string) =>
  href.startsWith("#") && !isHome ? `/${href}` : href;

const processedNavLinks = navLinks.map((link) => ({
  ...link,
  href: withHome(link.href),
}));
---

<header
  id="main-header"
  class:list={[
    "group fixed top-0 left-0 w-full z-50 transition-all duration-300 ease-in-out",
    !isHome && "bg-white/80 dark:bg-slate-900/80 backdrop-blur-lg shadow-lg",
  ]}
>
  <nav
    class="container mx-auto flex items-center justify-between px-6 py-3 sm:px-8"
  >
    <!-- Logo -->
    <a
      href={withHome("/#inicio")}
      class:list={[
        "flex items-center gap-2 sm:gap-3 font-bold text-lg sm:text-xl tracking-tight transition-colors",
        isHome
          ? "text-white group-[.scrolled]:text-slate-900 dark:group-[.scrolled]:text-white"
          : "text-slate-900 dark:text-white",
      ]}
    >
      <div
        class="relative rounded-lg p-[1px] bg-gradient-to-br from-white/40 via-white/20 to-white/40 backdrop-blur-sm"
      >
        <div class="rounded-lg">
          <img
            src="/logo.webp"
            alt={`Logo de ${siteSettings.siteName}`}
            class="h-8 w-8 sm:h-10 sm:w-10 object-contain rounded-lg"
            loading="eager"
          />
        </div>
      </div>

      <span>{siteSettings.siteName}</span>
    </a>

    <!-- Desktop Navigation -->
    <div
      class:list={[
        "hidden lg:flex items-center gap-x-8",
        isHome
          ? "text-white group-[.scrolled]:text-slate-700 dark:group-[.scrolled]:text-white"
          : "text-slate-700 dark:text-white",
      ]}
    >
      {
        processedNavLinks.map((link) => (
          <a
            href={link.href}
            class="text-sm font-medium transition-colors duration-200 hover:text-sky-300 dark:hover:text-sky-300 group-[.scrolled]:hover:text-sky-500 dark:group-[.scrolled]:hover:text-sky-300"
          >
            {link.label}
          </a>
        ))
      }
    </div>

    <!-- Action Buttons -->
    <div
      class:list={[
        "flex items-center gap-x-2",
        isHome
          ? "text-white group-[.scrolled]:text-slate-700 dark:group-[.scrolled]:text-white"
          : "text-slate-700 dark:text-white",
      ]}
    >
      <button
        id="theme-toggle"
        class="h-10 w-10 rounded-full flex items-center justify-center transition-colors hover:bg-black/10"
        type="button"
        aria-label="Cambiar tema"
      >
        <Icon
          name="lucide:sun-medium"
          class="h-5 w-5"
          data-theme-icon="light"
        />
        <Icon
          name="lucide:moon-star"
          class="h-5 w-5 hidden"
          data-theme-icon="dark"
        />
      </button>

      <!-- Mobile Menu Button -->
      <button
        id="mobile-menu-toggle"
        class="lg:hidden flex flex-col justify-center items-center gap-y-1.5 w-10 h-10 rounded-full transition-colors hover:bg-black/10"
        aria-label="Abrir menú"
        aria-expanded="false"
      >
        <span
          class:list={[
            "w-5 h-0.5 rounded-full transition-transform duration-300 ease-in-out origin-center",
            isHome
              ? "bg-white group-[.scrolled]:bg-slate-900 dark:group-[.scrolled]:bg-white"
              : "bg-slate-900 dark:bg-white",
          ]}
          aria-hidden="true"></span>
        <span
          class:list={[
            "w-5 h-0.5 rounded-full transition-transform duration-300 ease-in-out origin-center",
            isHome
              ? "bg-white group-[.scrolled]:bg-slate-900 dark:group-[.scrolled]:bg-white"
              : "bg-slate-900 dark:bg-white",
          ]}
          aria-hidden="true"></span>
      </button>
    </div>
  </nav>
</header>

<!-- Mobile Menu Panel -->
<div
  id="mobile-menu-panel"
  class="fixed top-0 right-0 h-full w-80 max-w-[88vw] backdrop-blur-xl shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-40 lg:hidden
  bg-white/85 text-slate-900 border-l border-white/40
  dark:bg-slate-900/90 dark:text-white dark:border-white/10"
>
  <div class="flex flex-col h-full p-8 pt-20 gap-y-6">
    <div class="flex flex-col gap-y-2">
      <p
        class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500 dark:text-white/60"
      >
        Navegacion
      </p>
      {
        processedNavLinks.map((link) => (
          <a
            href={link.href}
            class="text-base font-semibold transition-all mobile-nav-link rounded-2xl px-4 py-3
          hover:bg-slate-900/5 hover:text-slate-900
          dark:hover:bg-white/10 dark:hover:text-white"
          >
            {link.label}
          </a>
        ))
      }
    </div>

    <div class="mt-auto pt-2 pb-20 pr-16">
      <p class="mt-3 text-xs text-slate-500 dark:text-white/60">
        Atendemos de lunes a viernes y respondemos en horario hábil.
      </p>
    </div>
  </div>
</div>
<!-- Backdrop -->
<div
  id="mobile-menu-backdrop"
  class="fixed inset-0 bg-black/40 z-30 hidden lg:hidden"
>
</div>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    // --- Theme Toggler ---
    const themeToggleBtn = document.getElementById("theme-toggle");
    const THEME_KEY = "theme";

    const setThemeIcon = (theme) => {
      themeToggleBtn?.querySelectorAll("[data-theme-icon]").forEach((icon) => {
        icon.classList.toggle(
          "hidden",
          icon.getAttribute("data-theme-icon") !== theme,
        );
      });
    };

    const applyTheme = (theme) => {
      document.documentElement.classList.toggle("dark", theme === "dark");
      localStorage.setItem(THEME_KEY, theme);
      setThemeIcon(theme);
    };

    const storedTheme = localStorage.getItem(THEME_KEY);
    const prefersDark = window.matchMedia(
      "(prefers-color-scheme: dark)",
    ).matches;
    applyTheme(storedTheme || (prefersDark ? "dark" : "light"));

    themeToggleBtn?.addEventListener("click", () => {
      const nextTheme = document.documentElement.classList.contains("dark")
        ? "light"
        : "dark";
      applyTheme(nextTheme);
    });

    // --- Header Scroll Effect ---
    const header = document.getElementById("main-header");
    const handleScroll = () => {
      if (window.scrollY > 50) {
        header.classList.add("scrolled", "shadow-lg");
        header.classList.add(
          "bg-white/80",
          "dark:bg-slate-900/80",
          "backdrop-blur-lg",
        );
      } else {
        header.classList.remove("scrolled", "shadow-lg");
        header.classList.remove(
          "bg-white/80",
          "dark:bg-slate-900/80",
          "backdrop-blur-lg",
        );
      }
    };
    window.addEventListener("scroll", handleScroll, { passive: true });
    handleScroll(); // Initial check

    // --- Mobile Menu ---
    const menuToggle = document.getElementById("mobile-menu-toggle");
    const menuPanel = document.getElementById("mobile-menu-panel");
    const menuBackdrop = document.getElementById("mobile-menu-backdrop");
    const floatingWhatsappButton = document.getElementById(
      "whatsapp-floating-button",
    );
    const mobileNavLinks = document.querySelectorAll(".mobile-nav-link");
    const hamburgerSpans = menuToggle?.querySelectorAll("span");

    const openMenu = () => {
      menuPanel.classList.remove("translate-x-full");
      menuBackdrop.classList.remove("hidden");
      floatingWhatsappButton?.classList.add("is-expanded");
      document.body.style.overflow = "hidden";
      menuToggle.setAttribute("aria-expanded", "true");
      hamburgerSpans[0].style.transform = "translateY(4px) rotate(45deg)";
      hamburgerSpans[1].style.transform = "translateY(-4px) rotate(-45deg)";
    };

    const closeMenu = () => {
      menuPanel.classList.add("translate-x-full");
      menuBackdrop.classList.add("hidden");
      floatingWhatsappButton?.classList.remove("is-expanded");
      document.body.style.overflow = "";
      menuToggle.setAttribute("aria-expanded", "false");
      hamburgerSpans.forEach((span) => (span.style.transform = ""));
    };

    menuToggle.addEventListener("click", () => {
      const isExpanded = menuToggle.getAttribute("aria-expanded") === "true";
      isExpanded ? closeMenu() : openMenu();
    });

    menuBackdrop.addEventListener("click", closeMenu);
    mobileNavLinks.forEach((link) => link.addEventListener("click", closeMenu));
  });
</script>
