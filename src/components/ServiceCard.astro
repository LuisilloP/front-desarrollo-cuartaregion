---
import type { Service } from "../data/mock";
import { buildWhatsAppLink } from "../lib/utils";
import { Icon } from "astro-icon/components";

interface Props {
  service: Service;
  whatsappNumber: string;
}

const { service, whatsappNumber } = Astro.props;
const title = (service.title ?? "").trim();
const whatItSolves = service.what_it_solves ?? "";
const whatsappUrl = buildWhatsAppLink(whatsappNumber, `Hola! Me interesa el servicio ${title}.`);
const benefits = service.benefits?.slice(0, 3) ?? []; // Show max 3 benefits
const isFeatured = Boolean(service.featured);
const topBanner = (service.top_banner ?? "").trim();
const bannerLabel = topBanner || (isFeatured ? "MÃ¡s popular" : "");
const iconName = service.icon || "lucide:gem"; // Default icon
---
<a
  href={whatsappUrl}
  target="_blank"
  rel="noreferrer"
  class="card-shine group relative flex h-full flex-col rounded-3xl border p-6 backdrop-blur-xl transition-all duration-300 lg:p-8
  border-slate-900/10 bg-white/40 hover:border-slate-900/20 hover:!bg-white/60
  dark:border-white/10 dark:bg-white/5 dark:hover:border-white/20 dark:hover:!bg-white/[0.07]"
>
  {bannerLabel && (
    <span class="absolute right-6 top-6 inline-flex items-center rounded-full px-3 py-1 text-xs font-medium ring-1 ring-inset
    bg-sky-500/10 text-sky-600 ring-sky-500/20
    dark:bg-sky-400/10 dark:text-sky-300 dark:ring-sky-400/20"
    >
      {bannerLabel}
    </span>
  )}

  <div class="relative mb-6 flex h-12 w-12 items-center justify-center rounded-2xl border
  bg-sky-500/10 text-sky-600 border-sky-500/20
  dark:bg-sky-400/10 dark:text-sky-300 dark:border-sky-400/20"
  >
    <Icon name={iconName} class="h-6 w-6" />
  </div>

  <h3 class="text-2xl font-semibold leading-snug tracking-tight text-slate-900 dark:text-white">{title}</h3>

  {whatItSolves && <p class="mt-2 text-slate-600 dark:text-white/60">{whatItSolves}</p>}

  {benefits.length > 0 && (
    <ul class="mt-6 space-y-3 text-slate-700 dark:text-white/80">
      {benefits.map((benefit) => (
        <li class="flex items-start gap-3">
          <Icon name="lucide:check-circle" class="mt-1 h-4 w-4 flex-shrink-0 text-sky-500 dark:text-sky-300" />
          <span>{benefit}</span>
        </li>
      ))}
    </ul>
  )}

  <div class="mt-auto pt-8">
    <div class="inline-flex items-center gap-2 text-sm font-medium transition-colors
    text-sky-600 group-hover:text-sky-500
    dark:text-sky-300 dark:group-hover:text-sky-200"
    >
      Cotizar servicio <Icon name="lucide:arrow-right" class="h-4 w-4 transition-transform group-hover:translate-x-1" />
    </div>
  </div>
</a>

<style>
  :root {
    --shine-color: rgba(100, 116, 139, 0.1); /* slate-500 */
  }
  .dark {
    --shine-color: rgba(125, 211, 252, 0.1); /* sky-300 */
  }
  .card-shine {
    overflow: hidden;
  }
  .card-shine::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(
      400px circle at var(--mouse-x, -9999px) var(--mouse-y, -9999px),
      var(--shine-color),
      transparent 40%
    );
    border-radius: inherit;
    z-index: 0;
    transition: opacity 0.3s;
  }
</style>

<script is:inline>
  // This script can be run once, maybe in a global script,
  // but it's safe to run multiple times.
  function setupCardShine() {
    document.querySelectorAll('.card-shine').forEach(card => {
      // Check if the listener is already attached
      if (card.dataset.shineListener === 'true') return;

      card.addEventListener('mousemove', (e) => {
        const rect = card.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        card.style.setProperty('--mouse-x', `${x}px`);
        card.style.setProperty('--mouse-y', `${y}px`);
      });
      
      card.dataset.shineListener = 'true';
    });
  }
  
  // Initial setup
  setupCardShine();

  // In Astro, view transitions can cause scripts to re-run.
  // This also helps if cards are loaded dynamically.
  document.addEventListener('astro:after-swap', setupCardShine);
</script>
