---
import type { SiteSettings } from "../data/mock";
import { buildWhatsAppLink } from "../lib/utils";
import { Icon } from "astro-icon/components";

interface Props {
  siteSettings: SiteSettings;
}

const { siteSettings } = Astro.props;
const pathname = Astro.url?.pathname ?? "/";
const isHome = pathname === "/" || pathname === "";
const withHome = (href: string) => (href.startsWith("#") && !isHome ? `/${href}` : href);
const navLinks = [
  { href: withHome("#inicio"), label: "Inicio" },
  { href: withHome("#servicios"), label: "Servicios" },
  { href: withHome("#casos"), label: "Casos" },
  { href: withHome("#resenas"), label: "Testimonios" },
  { href: withHome("#contacto"), label: "Contacto" },
  { href: withHome("#faq"), label: "FAQ" }
];
const whatsappUrl = buildWhatsAppLink(siteSettings.whatsappNumber, "Hola! Quiero cotizar mi web o automatizacion.");

const headerClass = isHome
  ? "fixed inset-x-0 top-0 z-50"
  : "sticky top-0 z-50 bg-surface/90 backdrop-blur border-b border-border/70";
const shellClass = isHome ? "section-shell pt-6 pb-3" : "section-shell py-3";
const panelClass = isHome
  ? "flex items-center justify-between gap-3 rounded-3xl border border-border/70 bg-card/95 text-content shadow-soft backdrop-blur-xl px-4 sm:px-6 py-3 dark:border-transparent dark:bg-secondary/75 dark:text-contrast dark:shadow-[0_18px_80px_rgba(0,0,0,0.45)]"
  : "flex items-center justify-between gap-3 rounded-3xl border border-border/80 bg-surface/90 text-content shadow-soft backdrop-blur px-4 sm:px-6 py-3";
const logoBgClass = isHome
  ? "border border-border/60 bg-white/70 dark:border-transparent dark:bg-white/10"
  : "border border-border bg-card";
const titleClass = isHome
  ? "text-lg font-semibold text-content leading-tight dark:text-contrast"
  : "text-lg font-semibold text-content leading-tight";
const navLinkClass = isHome
  ? "text-content/80 hover:text-content transition-colors dark:text-contrast/80 dark:hover:text-contrast"
  : "text-muted hover:text-content transition-colors";
const iconBtnClass = isHome
  ? "items-center justify-center h-10 w-10 rounded-full border border-border/70 text-content bg-card/80 hover:bg-card dark:border-transparent dark:text-contrast dark:bg-white/10 dark:hover:bg-white/15"
  : "items-center justify-center h-10 w-10 rounded-full border border-border text-content bg-card hover:border-primary/60";
const mobileNavClass = `fixed z-50 inset-x-0 top-24 mx-auto w-[90%] max-w-sm flex flex-col gap-3 rounded-3xl p-5 shadow-2xl opacity-0 -translate-y-4 scale-95 pointer-events-none transition-all duration-200 hidden ${
  isHome
    ? "border border-border/80 bg-card/95 text-content backdrop-blur-xl shadow-soft dark:border-white/15 dark:bg-secondary/95 dark:text-contrast dark:shadow-[0_22px_90px_rgba(0,0,0,0.55)]"
    : "border border-border bg-card text-content"
}`;
const mobileLinkClass = isHome
  ? "px-4 py-3 rounded-2xl bg-card/80 text-left font-semibold text-content shadow-sm border border-border/70 hover:border-primary/30 hover:bg-card dark:bg-white/5 dark:text-contrast dark:border-white/10 dark:hover:border-white/20 dark:hover:bg-white/10"
  : "px-4 py-3 rounded-2xl bg-card text-left font-semibold text-content shadow-sm border border-border/80 hover:border-primary/40 hover:bg-surface-strong/20";
const mobileCtaClass = "mt-4 inline-flex items-center gap-2 px-4 py-3 rounded-full bg-[#25D366] text-white font-semibold shadow-soft hover:shadow-lg hover:-translate-y-0.5 transition justify-center";
---

<header class={headerClass}>
  <div class={shellClass}>
    <div class={panelClass}>
      <a href={withHome("#inicio")} class="flex items-center gap-3">
        <img
          src="/logo.png"
          alt={siteSettings.siteName}
          class={`h-14 w-auto rounded-2xl object-contain p-1.5 ${logoBgClass}`}
          loading="lazy"
        />
        <p class={titleClass}>{siteSettings.siteName}</p>
      </a>

      <nav class="hidden lg:flex items-center gap-6 text-sm">
        {navLinks.map((link) => (
          <a class={navLinkClass} href={link.href}>{link.label}</a>
        ))}
      </nav>

      <div class="flex items-center gap-2">
        <button
          id="theme-toggle"
          class={`hidden sm:inline-flex ${iconBtnClass}`}
          type="button"
          aria-label="Cambiar tema"
        >
          <Icon
            name="lucide:sun-medium"
            class="h-5 w-5"
            aria-hidden="true"
            data-theme-icon="light"
          />
          <Icon
            name="lucide:moon-star"
            class="h-5 w-5 hidden"
            aria-hidden="true"
            data-theme-icon="dark"
          />
        </button>
        <button
          id="menu-toggle"
          class={`lg:hidden inline-flex ${iconBtnClass}`}
          type="button"
          aria-label="Abrir menu"
          aria-controls="mobile-nav"
          aria-expanded="false"
        >
          <Icon name="lucide:menu" class="h-4 w-4" aria-hidden="true" />
        </button>
      </div>

      <nav
        id="mobile-nav"
        class={mobileNavClass}
      >
        <div class="flex flex-col gap-2">
          {navLinks.map((link) => (
            <a
              class={mobileLinkClass}
              href={link.href}
            >
              {link.label}
            </a>
          ))}
        </div>
        <a
          class={mobileCtaClass}
          href={whatsappUrl}
          target="_blank"
          rel="noreferrer"
        >
          <Icon name="simple-icons:whatsapp" class="h-4 w-4 text-white" aria-hidden="true" />
          WhatsApp
          <span aria-hidden="true">-></span>
        </a>
      </nav>
    </div>
  </div>
</header>

<script is:inline>
  const root = document.documentElement;
  const btn = document.getElementById("theme-toggle");
  const menuBtn = document.getElementById("menu-toggle");
  const mobileNav = document.getElementById("mobile-nav");
  const THEME_KEY = "theme";

  const setThemeIcon = (theme) => {
    btn?.querySelectorAll("[data-theme-icon]").forEach((icon) => {
      const target = icon.getAttribute("data-theme-icon");
      icon.classList.toggle("hidden", target !== theme);
    });
  };

  const applyTheme = (theme) => {
    if (theme === "dark") {
      root.classList.add("dark");
    } else {
      root.classList.remove("dark");
    }
    localStorage.setItem(THEME_KEY, theme);
    setThemeIcon(theme);
  };

  const stored = localStorage.getItem(THEME_KEY);
  const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
  applyTheme(stored || (prefersDark ? "dark" : "light"));

  btn?.addEventListener("click", () => {
    const next = root.classList.contains("dark") ? "light" : "dark";
    applyTheme(next);
  });

  const showMenu = () => {
    if (!mobileNav || !menuBtn) return;
    mobileNav.classList.remove("hidden");
    requestAnimationFrame(() => {
      mobileNav.classList.remove("opacity-0", "-translate-y-4", "scale-95", "pointer-events-none");
    });
    menuBtn.setAttribute("aria-expanded", "true");
  };

  const hideMenu = () => {
    if (!mobileNav || !menuBtn) return;
    mobileNav.classList.add("opacity-0", "-translate-y-4", "scale-95", "pointer-events-none");
    const handleTransitionEnd = () => {
      mobileNav.classList.add("hidden");
      menuBtn.setAttribute("aria-expanded", "false");
    };
    mobileNav.addEventListener("transitionend", handleTransitionEnd, { once: true });
  };

  const toggleMenu = () => {
    if (mobileNav?.classList.contains("hidden")) {
      showMenu();
    } else {
      hideMenu();
    }
  };

  menuBtn?.addEventListener("click", toggleMenu);
  document.addEventListener("click", (event) => {
    if (!mobileNav || !menuBtn) return;
    if (mobileNav.classList.contains("hidden")) return;
    const target = event.target;
    if (!(target instanceof Node)) return;
    if (mobileNav.contains(target) || menuBtn.contains(target)) return;
    hideMenu();
  });
  mobileNav?.querySelectorAll("a").forEach((anchor) => {
    anchor.addEventListener("click", hideMenu);
  });
</script>
