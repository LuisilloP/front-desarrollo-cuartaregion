---
import { Icon } from "astro-icon/components";
import type { SiteSettings, NavLink } from "../lib/api/types";
import { buildWhatsAppLink } from "../lib/utils";

interface Props {
  siteSettings: SiteSettings;
  navLinks: NavLink[];
}

const { siteSettings, navLinks } = Astro.props;
const pathname = Astro.url?.pathname ?? "/";
const isHome = pathname === "/" || pathname === "";
const withHome = (href: string) => (href.startsWith("#") && !isHome ? `/${href}` : href);

const processedNavLinks = navLinks.map(link => ({...link, href: withHome(link.href)}));
const whatsappUrl = buildWhatsAppLink(siteSettings.whatsappNumber, "Hola! Quiero cotizar mi web o automatizacion.");
---

<header 
  id="main-header"
  class="group fixed top-0 left-0 w-full z-50 transition-all duration-300 ease-in-out"
>
  <nav class="container mx-auto flex items-center justify-between px-4 py-3">
    <!-- Logo -->
    <a href={withHome("#inicio")} class="flex items-center gap-3 font-bold text-xl tracking-tight text-white group-[.scrolled]:text-slate-900 dark:group-[.scrolled]:text-white">
      <div class="bg-white/90 backdrop-blur-sm rounded-lg p-1">
        <img
          src="/logo.png"
          alt=`Logo de ${siteSettings.siteName}`
          class="h-10 w-10 object-contain"
          loading="eager"
        />
      </div>
      <span class="hidden sm:inline">{siteSettings.siteName}</span>
    </a>

    <!-- Desktop Navigation -->
    <div class="hidden lg:flex items-center gap-x-8 text-white group-[.scrolled]:text-slate-700 dark:group-[.scrolled]:text-white">
      {processedNavLinks.map(link => (
        <a href={link.href} class="text-sm font-medium transition-colors duration-200 hover:text-sky-300 dark:hover:text-sky-300 group-[.scrolled]:hover:text-sky-500 dark:group-[.scrolled]:hover:text-sky-300">
          {link.label}
        </a>
      ))}
    </div>

    <!-- Action Buttons -->
    <div class="flex items-center gap-x-2 text-white group-[.scrolled]:text-slate-700 dark:group-[.scrolled]:text-white">
      <button
        id="theme-toggle"
        class="h-10 w-10 rounded-full flex items-center justify-center transition-colors hover:bg-black/10"
        type="button"
        aria-label="Cambiar tema"
      >
        <Icon name="lucide:sun-medium" class="h-5 w-5" data-theme-icon="light" />
        <Icon name="lucide:moon-star" class="h-5 w-5 hidden" data-theme-icon="dark" />
      </button>

      <!-- Mobile Menu Button -->
      <button id="mobile-menu-toggle" class="lg:hidden flex flex-col justify-center items-center w-10 h-10 rounded-full transition-colors hover:bg-black/10" aria-label="Abrir menÃº" aria-expanded="false">
        <span class="w-5 h-0.5 rounded-full transition-transform duration-300 ease-in-out bg-white group-[.scrolled]:bg-slate-900 dark:group-[.scrolled]:bg-white" aria-hidden="true"></span>
        <span class="w-5 h-0.5 rounded-full my-1.5 transition-opacity duration-300 ease-in-out bg-white group-[.scrolled]:bg-slate-900 dark:group-[.scrolled]:bg-white" aria-hidden="true"></span>
        <span class="w-5 h-0.5 rounded-full transition-transform duration-300 ease-in-out bg-white group-[.scrolled]:bg-slate-900 dark:group-[.scrolled]:bg-white" aria-hidden="true"></span>
      </button>

      <a href={whatsappUrl} target="_blank" rel="noreferrer" class="hidden lg:flex items-center gap-2 px-4 py-2 rounded-full bg-[#25D366] text-white font-semibold text-sm hover:scale-105 transition-transform">
        <Icon name="simple-icons:whatsapp" class="h-4 w-4" />
        <span>Contactar</span>
      </a>
    </div>
  </nav>
</header>

<!-- Mobile Menu Panel -->
<div 
  id="mobile-menu-panel"
  class="fixed top-0 right-0 h-full w-72 backdrop-blur-lg shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-40 lg:hidden
  bg-white/90 text-slate-900
  dark:bg-slate-900/95 dark:text-white"
>
  <div class="flex flex-col p-8 pt-24 gap-y-6">
    {processedNavLinks.map(link => (
      <a href={link.href} class="text-lg font-semibold transition-colors mobile-nav-link
      hover:text-sky-600
      dark:hover:text-sky-300">
        {link.label}
      </a>
    ))}
    <a href={whatsappUrl} target="_blank" rel="noreferrer" class="mt-4 inline-flex items-center justify-center gap-2 px-4 py-3 rounded-full bg-[#25D366] text-white font-semibold shadow-soft hover:shadow-lg hover:-translate-y-0.5 transition">
      <Icon name="simple-icons:whatsapp" class="h-5 w-5" />
      <span>Cotizar por WhatsApp</span>
    </a>
  </div>
</div>
<!-- Backdrop -->
<div id="mobile-menu-backdrop" class="fixed inset-0 bg-black/40 z-30 hidden lg:hidden"></div>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    // --- Theme Toggler ---
    const themeToggleBtn = document.getElementById("theme-toggle");
    const THEME_KEY = "theme";

    const setThemeIcon = (theme) => {
      themeToggleBtn?.querySelectorAll("[data-theme-icon]").forEach((icon) => {
        icon.classList.toggle("hidden", icon.getAttribute("data-theme-icon") !== theme);
      });
    };

    const applyTheme = (theme) => {
      document.documentElement.classList.toggle("dark", theme === "dark");
      localStorage.setItem(THEME_KEY, theme);
      setThemeIcon(theme);
    };

    const storedTheme = localStorage.getItem(THEME_KEY);
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    applyTheme(storedTheme || (prefersDark ? "dark" : "light"));

    themeToggleBtn?.addEventListener("click", () => {
      const nextTheme = document.documentElement.classList.contains("dark") ? "light" : "dark";
      applyTheme(nextTheme);
    });

    // --- Header Scroll Effect ---
    const header = document.getElementById("main-header");
    const handleScroll = () => {
      if (window.scrollY > 50) {
        header.classList.add("scrolled", "shadow-lg");
        header.classList.add("bg-white/80", "dark:bg-slate-900/80", "backdrop-blur-lg");
      } else {
        header.classList.remove("scrolled", "shadow-lg");
        header.classList.remove("bg-white/80", "dark:bg-slate-900/80", "backdrop-blur-lg");
      }
    };
    window.addEventListener("scroll", handleScroll, { passive: true });
    handleScroll(); // Initial check

    // --- Mobile Menu ---
    const menuToggle = document.getElementById("mobile-menu-toggle");
    const menuPanel = document.getElementById("mobile-menu-panel");
    const menuBackdrop = document.getElementById("mobile-menu-backdrop");
    const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
    const hamburgerSpans = menuToggle?.querySelectorAll('span');

    const openMenu = () => {
      menuPanel.classList.remove('translate-x-full');
      menuBackdrop.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      menuToggle.setAttribute('aria-expanded', 'true');
      hamburgerSpans[0].style.transform = 'rotate(45deg) translate(5px, 5px)';
      hamburgerSpans[1].style.opacity = '0';
      hamburgerSpans[2].style.transform = 'rotate(-45deg) translate(5px, -5px)';
    };

    const closeMenu = () => {
      menuPanel.classList.add('translate-x-full');
      menuBackdrop.classList.add('hidden');
      document.body.style.overflow = '';
      menuToggle.setAttribute('aria-expanded', 'false');
      hamburgerSpans.forEach(span => span.style.transform = '');
      hamburgerSpans[1].style.opacity = '1';
    };

    menuToggle.addEventListener('click', () => {
      const isExpanded = menuToggle.getAttribute('aria-expanded') === 'true';
      isExpanded ? closeMenu() : openMenu();
    });

    menuBackdrop.addEventListener('click', closeMenu);
    mobileNavLinks.forEach(link => link.addEventListener('click', closeMenu));
  });
</script>
