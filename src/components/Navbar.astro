---
import type { SiteSettings } from "../data/mock";
import { buildWhatsAppLink } from "../lib/utils";
import { Icon } from "astro-icon/components";

interface Props {
  siteSettings: SiteSettings;
}

const { siteSettings } = Astro.props;
const pathname = Astro.url?.pathname ?? "/";
const isHome = pathname === "/" || pathname === "";
const withHome = (href: string) => (href.startsWith("#") && !isHome ? `/${href}` : href);
const navLinks = [
  { href: withHome("#inicio"), label: "Inicio" },
  { href: withHome("#servicios"), label: "Servicios" },
  { href: withHome("#casos"), label: "Casos" },
  { href: withHome("#resenas"), label: "Resenas" },
  { href: withHome("#contacto"), label: "Contacto" },
  { href: withHome("#faq"), label: "FAQ" }
];
const whatsappUrl = buildWhatsAppLink(siteSettings.whatsappNumber, "Hola! Quiero cotizar mi web o automatizacion.");
---

<header class="sticky top-0 z-50 bg-surface/90 backdrop-blur border-b border-border/70">
  <div class="section-shell flex items-center justify-between py-4 gap-3 relative">
    <a href={withHome("#inicio")} class="flex items-center gap-3">
      <img
        src="/logo.png"
        alt={siteSettings.siteName}
        class="h-20 w-auto rounded-2xl border border-border bg-card object-contain p-1.5"
        loading="lazy"
      />
      <p class="text-lg font-semibold text-content leading-tight">{siteSettings.siteName}</p>
    </a>

    <nav class="hidden lg:flex items-center gap-6 text-sm text-muted">
      {navLinks.map((link) => (
        <a class="hover:text-content transition-colors" href={link.href}>{link.label}</a>
      ))}
    </nav>

    <div class="flex items-center gap-2">
      <button
        id="theme-toggle"
        class="hidden sm:inline-flex items-center justify-center h-10 w-10 rounded-full border border-border text-content bg-card hover:border-primary/60"
        type="button"
        aria-label="Cambiar tema"
      >
        <Icon
          name="lucide:sun-medium"
          class="h-5 w-5"
          aria-hidden="true"
          data-theme-icon="light"
        />
        <Icon
          name="lucide:moon-star"
          class="h-5 w-5 hidden"
          aria-hidden="true"
          data-theme-icon="dark"
        />
      </button>
      <button
        id="menu-toggle"
        class="lg:hidden inline-flex items-center justify-center h-10 w-10 rounded-full border border-border text-content bg-card hover:border-primary/60"
        type="button"
        aria-label="Abrir menu"
        aria-controls="mobile-nav"
        aria-expanded="false"
      >
        Menu
      </button>
    </div>

    <div
      id="mobile-overlay"
      class="fixed inset-0 z-40 bg-surface-strong/60 opacity-0 pointer-events-none transition-opacity duration-200 hidden"
    ></div>
    <nav
      id="mobile-nav"
      class="fixed z-50 inset-x-0 top-24 mx-auto w-[90%] max-w-sm flex flex-col gap-3 rounded-3xl border border-border bg-card text-content p-5 shadow-2xl opacity-0 -translate-y-4 scale-95 pointer-events-none transition-all duration-200 hidden"
    >
      <div class="flex flex-col gap-2">
        {navLinks.map((link) => (
          <a
            class="px-4 py-3 rounded-2xl bg-card text-left font-semibold text-content shadow-sm border border-border/80 hover:border-primary/40 hover:bg-surface-strong/20"
            href={link.href}
          >
            {link.label}
          </a>
        ))}
      </div>
      <a
        class="mt-4 inline-flex items-center gap-2 px-4 py-3 rounded-full bg-gradient-to-r from-primary to-accent text-secondary font-semibold shadow-soft hover:shadow-lg transition justify-center"
        href={whatsappUrl}
        target="_blank"
        rel="noreferrer"
      >
        WhatsApp
        <span aria-hidden="true">-></span>
      </a>
    </nav>
  </div>
</header>

<script is:inline>
  const root = document.documentElement;
  const btn = document.getElementById("theme-toggle");
  const menuBtn = document.getElementById("menu-toggle");
  const mobileNav = document.getElementById("mobile-nav");
  const overlay = document.getElementById("mobile-overlay");
  const THEME_KEY = "theme";

  const setThemeIcon = (theme) => {
    btn?.querySelectorAll("[data-theme-icon]").forEach((icon) => {
      const target = icon.getAttribute("data-theme-icon");
      icon.classList.toggle("hidden", target !== theme);
    });
  };

  const applyTheme = (theme) => {
    if (theme === "dark") {
      root.classList.add("dark");
    } else {
      root.classList.remove("dark");
    }
    localStorage.setItem(THEME_KEY, theme);
    setThemeIcon(theme);
  };

  const stored = localStorage.getItem(THEME_KEY);
  const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
  applyTheme(stored || (prefersDark ? "dark" : "light"));

  btn?.addEventListener("click", () => {
    const next = root.classList.contains("dark") ? "light" : "dark";
    applyTheme(next);
  });

  const showMenu = () => {
    if (!mobileNav || !overlay || !menuBtn) return;
    overlay.classList.remove("hidden");
    mobileNav.classList.remove("hidden");
    requestAnimationFrame(() => {
      overlay.classList.remove("opacity-0", "pointer-events-none");
      mobileNav.classList.remove("opacity-0", "-translate-y-4", "scale-95", "pointer-events-none");
    });
    menuBtn.setAttribute("aria-expanded", "true");
  };

  const hideMenu = () => {
    if (!mobileNav || !overlay || !menuBtn) return;
    overlay.classList.add("opacity-0", "pointer-events-none");
    mobileNav.classList.add("opacity-0", "-translate-y-4", "scale-95", "pointer-events-none");
    const handleTransitionEnd = () => {
      overlay.classList.add("hidden");
      mobileNav.classList.add("hidden");
      menuBtn.setAttribute("aria-expanded", "false");
    };
    mobileNav.addEventListener("transitionend", handleTransitionEnd, { once: true });
  };

  const toggleMenu = () => {
    if (mobileNav?.classList.contains("hidden")) {
      showMenu();
    } else {
      hideMenu();
    }
  };

  menuBtn?.addEventListener("click", toggleMenu);
  overlay?.addEventListener("click", hideMenu);
  mobileNav?.querySelectorAll("a").forEach((anchor) => {
    anchor.addEventListener("click", hideMenu);
  });
</script>
