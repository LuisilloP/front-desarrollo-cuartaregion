---
import type { Service } from "../../data/mock";
import { buildWhatsAppLink } from "../../lib/utils";
import { Icon } from "astro-icon/components";

interface Props {
  service: Service;
  whatsappNumber: string;
}

const { service, whatsappNumber } = Astro.props;
const title = (service.title ?? "").trim();
const whatItSolves = service.what_it_solves ?? "";
const whatsappDesc = (service.whatsapp_desc ?? "").trim();
const whatsappUrl = buildWhatsAppLink(
  whatsappNumber,
  whatsappDesc || `Hola! Quiero cotizar el servicio ${title || "servicio"}.`,
);
const benefits = service.benefits?.slice(0, 3) ?? []; // Show max 3 benefits
const isFeatured = Boolean(service.featured);
const topBanner = (service.top_banner ?? "").trim();
const bannerLabel = topBanner || (isFeatured ? "Más popular" : "");
const iconName = service.icon || "lucide:gem"; // Default icon
const price = (service.price ?? "").trim();
const deliveryTime = (service.delivery_time ?? "").trim();
const modality = (service.modality ?? "").trim();
const ctaLabel = (service.ctaLabel ?? "").trim() || "Cotizar este plan";
const ctaHref = (service.ctaHref ?? "").trim();
const variant = (service.variant ?? "web") as "web" | "marketing" | "mixed";
const isMixed = variant === "mixed";
const accentTone =
  variant === "web" ? null : service.accent === "amber" ? "amber" : "orange";

const webAccent = {
  banner:
    "bg-sky-500/10 text-sky-600 ring-sky-500/20 dark:bg-sky-400/10 dark:text-sky-300 dark:ring-sky-400/20",
  icon: "bg-sky-500/10 text-sky-600 border-sky-500/20 dark:bg-sky-400/10 dark:text-sky-300 dark:border-sky-400/20",
  modality:
    "bg-blue-50 text-blue-700 ring-blue-700/10 dark:bg-blue-400/10 dark:text-blue-400 dark:ring-blue-400/30",
  check: "text-sky-500 dark:text-sky-300",
  cta: "text-sky-600 group-hover:text-sky-500 dark:text-sky-300 dark:group-hover:text-sky-200",
};

const marketingAccents = {
  amber: {
    banner:
      "bg-amber-500/10 text-amber-600 ring-amber-500/20 dark:bg-amber-400/10 dark:text-amber-300 dark:ring-amber-400/20",
    icon: "bg-amber-500/10 text-amber-600 border-amber-500/20 dark:bg-amber-400/10 dark:text-amber-300 dark:border-amber-400/20",
    modality:
      "bg-amber-50 text-amber-700 ring-amber-700/10 dark:bg-amber-400/10 dark:text-amber-400 dark:ring-amber-400/30",
    check: "text-amber-500 dark:text-amber-300",
    cta: "text-amber-600 group-hover:text-amber-500 dark:text-amber-300 dark:group-hover:text-amber-200",
    shine: "rgba(245, 158, 11, 0.16)",
  },
  orange: {
    banner:
      "bg-orange-500/10 text-orange-600 ring-orange-500/20 dark:bg-orange-400/10 dark:text-orange-300 dark:ring-orange-400/20",
    icon: "bg-orange-500/10 text-orange-600 border-orange-500/20 dark:bg-orange-400/10 dark:text-orange-300 dark:border-orange-400/20",
    modality:
      "bg-orange-50 text-orange-700 ring-orange-700/10 dark:bg-orange-400/10 dark:text-orange-400 dark:ring-orange-400/30",
    check: "text-orange-500 dark:text-orange-300",
    cta: "text-orange-600 group-hover:text-orange-500 dark:text-orange-300 dark:group-hover:text-orange-200",
    shine: "rgba(249, 115, 22, 0.16)",
  },
} as const;

const accent =
  variant === "web"
    ? webAccent
    : marketingAccents[accentTone ?? "orange"];

const mixedAccent = {
  banner:
    "bg-sky-500/10 text-sky-600 ring-sky-500/20 dark:bg-sky-400/10 dark:text-sky-300 dark:ring-sky-400/20",
  icon: "bg-orange-500/10 text-orange-600 border-orange-500/20 dark:bg-orange-400/10 dark:text-orange-300 dark:border-orange-400/20",
  modality:
    "bg-orange-50 text-orange-700 ring-orange-700/10 dark:bg-orange-400/10 dark:text-orange-400 dark:ring-orange-400/30",
  check:
    "text-amber-500 dark:text-amber-300 group-hover:text-sky-500 dark:group-hover:text-sky-300",
  cta: "text-amber-500 group-hover:text-sky-500 dark:text-amber-300 dark:group-hover:text-sky-300",
  shine: "rgba(56, 189, 248, 0.16)",
};

const resolvedAccent = isMixed ? mixedAccent : accent;
const deliveryChipClass = isMixed
  ? "bg-sky-500/10 text-sky-600 ring-sky-500/20 dark:bg-sky-400/10 dark:text-sky-300 dark:ring-sky-400/20"
  : "bg-slate-100 text-slate-600 ring-slate-500/10 dark:bg-slate-400/10 dark:text-slate-400 dark:ring-slate-400/20";
const mixedCardClass = isMixed ? "ring-1 ring-white/10" : "";

const shineStyle =
  variant === "web" ? undefined : `--shine-color: ${resolvedAccent.shine};`;
// For maintenance, text is "Activación: ...", otherwise "Entrega: ..."
const deliveryLabel =
  service.slug === "mantencion-ti-monitoreo" ? "Activación" : "Entrega";

const linkHref = isMixed ? whatsappUrl : ctaHref || whatsappUrl;
const isExternal = linkHref.startsWith("http");

const ctaBaseClass =
  "cta-button inline-flex min-h-12 w-full cursor-pointer items-center justify-between gap-3 rounded-2xl px-5 py-3.5 text-lg font-semibold tracking-[0.01em] shadow-md ring-1 transition-all duration-200 hover:-translate-y-0.5 hover:shadow-lg sm:min-h-11 sm:py-3 sm:text-base lg:min-h-10 lg:py-2.5 lg:text-sm 2xl:w-auto 2xl:justify-center";

const ctaButtonClass = isMixed
  ? "bg-gradient-to-r from-blue-600 to-amber-500 text-white ring-blue-300/35 shadow-lg shadow-blue-900/20 group-hover:from-blue-700 group-hover:to-amber-600"
  : variant === "web"
    ? "bg-blue-600 text-white ring-blue-900/20 shadow-blue-900/15 group-hover:bg-blue-700"
    : accentTone === "amber"
      ? "bg-gradient-to-r from-amber-200 to-orange-300 text-slate-900 ring-orange-300/45 shadow-amber-900/10 group-hover:from-amber-300 group-hover:to-orange-400"
      : "bg-gradient-to-r from-amber-200 to-orange-300 text-slate-900 ring-orange-300/45 shadow-amber-900/10 group-hover:from-amber-300 group-hover:to-orange-400";

const ctaFocusClass = isMixed
  ? "group-focus-visible:ring-2 group-focus-visible:ring-blue-300 group-focus-visible:ring-offset-2 group-focus-visible:ring-offset-white dark:group-focus-visible:ring-offset-slate-950"
  : variant === "web"
    ? "group-focus-visible:ring-2 group-focus-visible:ring-blue-300 group-focus-visible:ring-offset-2 group-focus-visible:ring-offset-white dark:group-focus-visible:ring-offset-slate-950"
    : "group-focus-visible:ring-2 group-focus-visible:ring-orange-300 group-focus-visible:ring-offset-2 group-focus-visible:ring-offset-white dark:group-focus-visible:ring-offset-slate-950";

const ctaIconClass =
  variant === "marketing" && accentTone === "amber"
    ? "text-slate-950"
    : variant === "web" || isMixed
      ? "text-white"
      : "text-slate-950";
---

<a
  href={linkHref}
  target={isExternal ? "_blank" : undefined}
  rel={isExternal ? "noreferrer" : undefined}
  data-variant={variant}
  data-accent={accentTone ?? undefined}
  style={shineStyle}
  class={`card-shine group relative z-0 flex h-full flex-col rounded-3xl border p-6 backdrop-blur-xl transition-all duration-300 lg:p-8 hover:scale-[1.02] shadow-lg hover:shadow-2xl
  border-slate-900/10 bg-white/40 hover:border-slate-900/20 hover:!bg-white/60
  dark:border-white/10 dark:bg-white/5 dark:hover:border-white/20 dark:hover:!bg-white/[0.07]
  ${mixedCardClass}`}
>
  {
    isMixed && (
      <div class="pointer-events-none absolute inset-0 z-0">
        <div class="absolute inset-0 bg-[radial-gradient(620px_circle_at_15%_20%,rgba(56,189,248,0.20),transparent_60%)]" />
        <div class="absolute inset-0 bg-[radial-gradient(660px_circle_at_85%_80%,rgba(251,146,60,0.18),transparent_60%)]" />
        <div class="absolute inset-0 bg-[linear-gradient(135deg,rgba(56,189,248,0.08),rgba(251,146,60,0.08))] opacity-40 blur-2xl" />
      </div>
    )
  }

  <div class="z-10 flex h-full flex-col">
  {
    bannerLabel && (
      <span
        class={`absolute right-6 top-6 z-10 inline-flex shrink-0 items-center rounded-full px-3 py-1 text-xs font-medium ring-1 ring-inset ${resolvedAccent.banner}`}
      >
        {bannerLabel}
      </span>
    )
  }

  <div
    class={`relative mb-6 flex h-12 w-12 items-center justify-center rounded-2xl border ${resolvedAccent.icon}`}
  >
    <Icon name={iconName} class="h-6 w-6" />
  </div>

  <h3
    class="text-2xl font-semibold leading-snug tracking-tight text-slate-900 dark:text-white"
  >
    {title}
  </h3>

  {
    whatItSolves && (
      <p class="mt-2 text-slate-600 dark:text-white/60">{whatItSolves}</p>
    )
  }

  {/* Chips for Delivery & Modality */}
  <div class="mt-4 flex flex-wrap gap-2">
    {
      deliveryTime && (
        <span
          class={`inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset ${deliveryChipClass}`}
        >
          {deliveryLabel}: {deliveryTime}
        </span>
      )
    }
    {
      modality && (
        <span
          class={`inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset ${resolvedAccent.modality}`}
        >
          Modalidad: {modality}
        </span>
      )
    }
  </div>

  {
    benefits.length > 0 && (
      <ul class="mt-6 space-y-3 text-slate-700 dark:text-white/80">
        {benefits.map((benefit) => (
          <li class="flex items-start gap-3">
            <Icon
              name="lucide:check-circle"
              class={`mt-1 h-4 w-4 flex-shrink-0 ${resolvedAccent.check}`}
            />
            <span>{benefit}</span>
          </li>
        ))}
      </ul>
    )
  }

  <div class="mt-auto flex flex-col items-start gap-3 pt-8 2xl:flex-row 2xl:items-end 2xl:justify-between">
    {
      price && (
        <div class="shrink-0">
          <span class="text-[10px] font-semibold uppercase tracking-widest text-slate-500/80 dark:text-white/60">
            Desde
          </span>
          <span class="mt-1 block text-lg font-semibold text-slate-900 dark:text-white">
            {price}
          </span>
          <span class="block text-[10px] text-slate-500 dark:text-slate-400 mt-0.5 font-medium">
            NO Incluye IVA
          </span>
        </div>
      )
    }
    <div
      class={`${ctaBaseClass} ${ctaButtonClass} ${ctaFocusClass}`}
    >
      <span class="text-left leading-tight">{ctaLabel}</span>
      <Icon
        name="lucide:arrow-right"
        class={`cta-arrow ml-auto h-4 w-4 flex-shrink-0 transition-transform duration-200 ${ctaIconClass}`}
      />
    </div>
  </div>
</div>
</a>

<style>
  :root {
    --shine-color: rgba(100, 116, 139, 0.1); /* slate-500 */
  }
  .dark {
    --shine-color: rgba(125, 211, 252, 0.1); /* sky-300 */
  }
  .card-shine {
    overflow: hidden;
  }
  .card-shine::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(
      400px circle at var(--mouse-x, -9999px) var(--mouse-y, -9999px),
      var(--shine-color),
      transparent 40%
    );
    border-radius: inherit;
    z-index: -1;
    pointer-events: none;
    transition: opacity 0.3s;
  }

  @keyframes cta-arrow-nudge {
    0%,
    100% {
      transform: translateX(0);
    }
    50% {
      transform: translateX(4px);
    }
  }

  @media (hover: hover) {
    .cta-button:hover .cta-arrow {
      animation: cta-arrow-nudge 520ms ease-out 1;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .cta-button {
      transition: none;
    }
    .cta-arrow {
      transition: none;
      animation: none !important;
    }
  }
</style>

<script is:inline>
  // This script can be run once, maybe in a global script,
  // but it's safe to run multiple times.
  function setupCardShine() {
    document.querySelectorAll(".card-shine").forEach((card) => {
      // Check if the listener is already attached
      if (card.dataset.shineListener === "true") return;

      card.addEventListener("mousemove", (e) => {
        const rect = card.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        card.style.setProperty("--mouse-x", `${x}px`);
        card.style.setProperty("--mouse-y", `${y}px`);
      });

      card.dataset.shineListener = "true";
    });
  }

  // Initial setup
  setupCardShine();

  // In Astro, view transitions can cause scripts to re-run.
  // This also helps if cards are loaded dynamically.
  document.addEventListener("astro:after-swap", setupCardShine);
</script>
