---
import type { CaseStudy } from "../../lib/api/types";

interface Props {
  caseItem: CaseStudy;
}

const { caseItem } = Astro.props;

const clientName = (caseItem.clientName ?? "").trim();
const title = (caseItem.title ?? "").trim() || clientName;
const summary = (caseItem.summary ?? "").trim();
const truncateText = (text: string, maxChars: number) => {
  if (text.length <= maxChars) return text;
  const clipped = text.slice(0, maxChars);
  const lastSpace = clipped.lastIndexOf(" ");
  const safeCut = lastSpace > Math.floor(maxChars * 0.6) ? lastSpace : maxChars;
  return `${clipped.slice(0, safeCut).trimEnd()}...`;
};
const summaryPreview = truncateText(summary, 175);
const coverAlt =
  caseItem.coverImageAlt || `Caso de Ã©xito de ${caseItem.clientName || title}`;
const href = `/casos/${caseItem.slug}`;

const projectContext = [
  caseItem.title ?? "",
  summary,
  caseItem.ctaPrimaryLabel ?? "",
]
  .join(" ")
  .toLowerCase();

const hasMarketingIntent =
  /(marketing|campa|ads|meta|google|leads|trafico|embudo|social|conversion)/.test(
    projectContext,
  );
const hasDevelopmentIntent =
  /(web|landing|sitio|pagina|plataforma|sistema|desarrollo|software|app|catalogo|pedidos)/.test(
    projectContext,
  );

const projectTypeLabel =
  hasMarketingIntent && hasDevelopmentIntent
    ? "Proyecto Mixto"
    : hasMarketingIntent
      ? "Marketing"
      : "Desarrollo Web";

const projectTypePillClass =
  projectTypeLabel === "Marketing"
    ? "border-amber-200 bg-amber-50 text-amber-900 dark:border-amber-300/20 dark:bg-amber-300/10 dark:text-amber-200"
    : projectTypeLabel === "Proyecto Mixto"
      ? "border-slate-300 bg-slate-100 text-slate-700 dark:border-slate-300/20 dark:bg-slate-300/10 dark:text-slate-200"
      : "border-sky-200 bg-sky-50 text-sky-900 dark:border-sky-300/20 dark:bg-sky-300/10 dark:text-sky-200";
---

<a
  href={href}
  class="group flex h-full flex-col overflow-hidden rounded-2xl border border-black/10 bg-white/70 shadow-lg backdrop-blur-sm transition-all duration-300 hover:-translate-y-1 hover:shadow-2xl dark:border-white/10 dark:bg-white/5"
>
  <div class="relative aspect-[16/9] overflow-hidden">
    {
      caseItem.coverImage ? (
        <img
          src={caseItem.coverImage}
          alt={coverAlt}
          width="800"
          height="450"
          loading="lazy"
          class="h-full w-full object-cover object-left transition-transform duration-500 ease-out group-hover:scale-110"
        />
      ) : (
        <div class="h-full w-full bg-gradient-to-br from-blue-500 via-purple-600 to-pink-500" />
      )
    }

    <div
      class="absolute inset-0 bg-gradient-to-t from-black/25 via-transparent to-transparent"
      aria-hidden="true"
    >
    </div>

    {
      caseItem.industry && (
        <div class="absolute left-3 top-3 inline-flex items-center rounded-full border border-black/10 bg-white/90 px-3 py-1 text-xs font-semibold text-slate-900 backdrop-blur-md dark:border-white/20 dark:bg-black/60 dark:text-white">
          {caseItem.industry}
        </div>
      )
    }

  </div>

  <div class="flex min-h-[220px] flex-1 flex-col p-6">
    <div class="space-y-2">
      {
        clientName && (
          <p class="h-4 max-w-full truncate text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">
            {clientName}
          </p>
        )
      }

      <div class="h-16">
        <h3
          class="line-clamp-2 max-w-full text-xl font-bold leading-tight text-slate-900 dark:text-white md:text-2xl"
        >
          {title}
        </h3>
      </div>
    </div>

    {
      summaryPreview && (
        <p
          class="mt-3 h-[5.5rem] max-w-[56ch] overflow-hidden text-sm leading-relaxed text-slate-600 dark:text-slate-300"
        >
          {summaryPreview}
        </p>
      )
    }

    <div class="mt-auto flex items-end justify-between gap-3 pt-4">
      <div
        class="flex items-center gap-2 text-sm font-semibold text-blue-600 transition-all duration-300 group-hover:gap-3 dark:text-blue-400"
      >
        <span>Ver caso</span>
        <svg
          class="h-4 w-4 transition-transform duration-300 group-hover:translate-x-1"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2.5"
            d="M13 7l5 5m0 0l-5 5m5-5H6"
          ></path>
        </svg>
      </div>

      <p
        class={`inline-flex w-fit items-center rounded-full border px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.12em] md:text-[11px] ${projectTypePillClass}`}
      >
        {projectTypeLabel}
      </p>
    </div>
  </div>
</a>
